<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>synchronized关键字详解 | GM的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="stylesheet" href="/blog/custom.css">
    <script src="/blog/custom.js"></script>
    <meta name="description" content="博观约取、厚积薄发。">
    
    <link rel="preload" href="/blog/assets/css/0.styles.0612dbff.css" as="style"><link rel="preload" href="/blog/assets/js/app.ee3639f3.js" as="script"><link rel="preload" href="/blog/assets/js/7.1252e5d3.js" as="script"><link rel="preload" href="/blog/assets/js/2.11926632.js" as="script"><link rel="preload" href="/blog/assets/js/1.9554eb00.js" as="script"><link rel="preload" href="/blog/assets/js/64.222454f0.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.1c094f7e.js"><link rel="prefetch" href="/blog/assets/js/11.e2b3a97a.js"><link rel="prefetch" href="/blog/assets/js/14.9120b7e5.js"><link rel="prefetch" href="/blog/assets/js/15.b8076c0b.js"><link rel="prefetch" href="/blog/assets/js/16.5627e9c8.js"><link rel="prefetch" href="/blog/assets/js/17.9917dc89.js"><link rel="prefetch" href="/blog/assets/js/18.94e52d84.js"><link rel="prefetch" href="/blog/assets/js/19.9a29cc64.js"><link rel="prefetch" href="/blog/assets/js/20.edcc8fad.js"><link rel="prefetch" href="/blog/assets/js/21.4268d6f7.js"><link rel="prefetch" href="/blog/assets/js/22.f6b8bd65.js"><link rel="prefetch" href="/blog/assets/js/23.1ed14112.js"><link rel="prefetch" href="/blog/assets/js/24.f9175dcd.js"><link rel="prefetch" href="/blog/assets/js/25.c6f5c5c0.js"><link rel="prefetch" href="/blog/assets/js/26.692e69bd.js"><link rel="prefetch" href="/blog/assets/js/27.a396b304.js"><link rel="prefetch" href="/blog/assets/js/28.80f4d077.js"><link rel="prefetch" href="/blog/assets/js/29.f9fd30a7.js"><link rel="prefetch" href="/blog/assets/js/3.09c21588.js"><link rel="prefetch" href="/blog/assets/js/30.2962fbba.js"><link rel="prefetch" href="/blog/assets/js/31.39d4cb55.js"><link rel="prefetch" href="/blog/assets/js/32.97324ada.js"><link rel="prefetch" href="/blog/assets/js/33.72f5128a.js"><link rel="prefetch" href="/blog/assets/js/34.d9e34b8a.js"><link rel="prefetch" href="/blog/assets/js/35.c4f7378c.js"><link rel="prefetch" href="/blog/assets/js/36.71d98d02.js"><link rel="prefetch" href="/blog/assets/js/37.4f98f5cd.js"><link rel="prefetch" href="/blog/assets/js/38.aef76b4e.js"><link rel="prefetch" href="/blog/assets/js/39.704f6335.js"><link rel="prefetch" href="/blog/assets/js/4.4df200ee.js"><link rel="prefetch" href="/blog/assets/js/40.ae2ee5d5.js"><link rel="prefetch" href="/blog/assets/js/41.49693efd.js"><link rel="prefetch" href="/blog/assets/js/42.4c8165d0.js"><link rel="prefetch" href="/blog/assets/js/43.fe59afed.js"><link rel="prefetch" href="/blog/assets/js/44.9589f085.js"><link rel="prefetch" href="/blog/assets/js/45.0dec6691.js"><link rel="prefetch" href="/blog/assets/js/46.8a5d12f2.js"><link rel="prefetch" href="/blog/assets/js/47.b1a86305.js"><link rel="prefetch" href="/blog/assets/js/48.e7d668ba.js"><link rel="prefetch" href="/blog/assets/js/49.5dbe385a.js"><link rel="prefetch" href="/blog/assets/js/5.4b086b5d.js"><link rel="prefetch" href="/blog/assets/js/50.b687e15f.js"><link rel="prefetch" href="/blog/assets/js/51.b66b8abf.js"><link rel="prefetch" href="/blog/assets/js/52.d35121bd.js"><link rel="prefetch" href="/blog/assets/js/53.e6a6685a.js"><link rel="prefetch" href="/blog/assets/js/54.6663d1e6.js"><link rel="prefetch" href="/blog/assets/js/55.da85728d.js"><link rel="prefetch" href="/blog/assets/js/56.1005accd.js"><link rel="prefetch" href="/blog/assets/js/57.770f2398.js"><link rel="prefetch" href="/blog/assets/js/58.76714c33.js"><link rel="prefetch" href="/blog/assets/js/59.70565292.js"><link rel="prefetch" href="/blog/assets/js/6.9ddc0919.js"><link rel="prefetch" href="/blog/assets/js/60.d1938db3.js"><link rel="prefetch" href="/blog/assets/js/61.081514ce.js"><link rel="prefetch" href="/blog/assets/js/62.d540dc0d.js"><link rel="prefetch" href="/blog/assets/js/63.6dc53660.js"><link rel="prefetch" href="/blog/assets/js/65.6c89208e.js"><link rel="prefetch" href="/blog/assets/js/66.97b55a6d.js"><link rel="prefetch" href="/blog/assets/js/67.21472b63.js"><link rel="prefetch" href="/blog/assets/js/68.6f0c23c9.js"><link rel="prefetch" href="/blog/assets/js/69.139804bc.js"><link rel="prefetch" href="/blog/assets/js/70.8a446d8d.js"><link rel="prefetch" href="/blog/assets/js/71.51d8381b.js"><link rel="prefetch" href="/blog/assets/js/72.2437ff64.js"><link rel="prefetch" href="/blog/assets/js/73.aef35191.js"><link rel="prefetch" href="/blog/assets/js/74.6debe979.js"><link rel="prefetch" href="/blog/assets/js/75.570cc2cb.js"><link rel="prefetch" href="/blog/assets/js/76.05eba155.js"><link rel="prefetch" href="/blog/assets/js/77.f3c29873.js"><link rel="prefetch" href="/blog/assets/js/78.cf5df647.js"><link rel="prefetch" href="/blog/assets/js/79.ca850d7b.js"><link rel="prefetch" href="/blog/assets/js/8.821d0483.js"><link rel="prefetch" href="/blog/assets/js/9.6b3bbad7.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.6e140397.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.0612dbff.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>GM的博客</h3> <p class="description" data-v-59e6cb88>博观约取、厚积薄发。</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/head.jpg" alt="GM的博客" class="logo"> <span class="site-name">GM的博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://deepjava-gm.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      GM的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/deepjava-gm" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/qq_37883866" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>41</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="https://deepjava-gm.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      GM的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/deepjava-gm" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/qq_37883866" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/blog/" class="sidebar-heading clickable router-link-active"><span>构建自己的Java知识体系</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/" aria-current="page" class="sidebar-link">引言</a></li><li><a href="/blog/contact.html" class="sidebar-link">反馈</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/javabase/一、Java基础知识" class="sidebar-heading clickable"><span>Java基础</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/java-collection/一、Java集合概述" class="sidebar-heading clickable"><span>Java集合</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/java-concurrent/一、Java并发编程基础知识点" class="sidebar-heading clickable open"><span>Java并发编程</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/java-concurrent/一、Java并发编程基础知识点.html" class="sidebar-link">一、Java并发编程基础知识点</a></li><li><a href="/blog/java-concurrent/二、JMM(Java内存模型)详解.html" class="sidebar-link">二、JMM(Java内存模型)详解</a></li><li><a href="/blog/java-concurrent/三、volatile关键字详解.html" class="sidebar-link">三、volatile关键字详解</a></li><li><a href="/blog/java-concurrent/四、synchronized关键字详解.html" class="active sidebar-link">四、synchronized关键字详解</a></li><li><a href="/blog/java-concurrent/五、AQS详解.html" class="sidebar-link">五、AQS详解</a></li><li><a href="/blog/java-concurrent/六、LockSupport详解.html" class="sidebar-link">六、LockSupport详解</a></li><li><a href="/blog/java-concurrent/七、JUC包下的并发工具类.html" class="sidebar-link">七、JUC包下的并发工具类</a></li><li><a href="/blog/java-concurrent/八、ThreadLocal详解.html" class="sidebar-link">八、ThreadLocal详解</a></li><li><a href="/blog/java-concurrent/九、Java锁详解.html" class="sidebar-link">九、Java锁详解</a></li><li><a href="/blog/java-concurrent/十、ReentrantReadWriteLock详解.html" class="sidebar-link">十、ReentrantReadWriteLock详解</a></li><li><a href="/blog/java-concurrent/十一、StampedLock详解.html" class="sidebar-link">十一、StampedLock详解</a></li><li><a href="/blog/java-concurrent/十二、Java线程池.html" class="sidebar-link">十二、Java线程池</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88></h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">synchronized关键字详解</h1> <div data-v-8a445198><!----> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 id="synchronized关键字详解"><a href="#synchronized关键字详解" class="header-anchor">#</a> synchronized关键字详解</h1> <h2 id="_1、synchronized关键字简介"><a href="#_1、synchronized关键字简介" class="header-anchor">#</a> 1、synchronized关键字简介</h2> <p>synchronized 直译为 同步，它的作用是实现线程同步， synchronized 能够确保同一时刻只有一个线程可以执行某个代码块或方法，我们可以把共享变量的修改放在synchronized 修饰的代码块中或者方法中，从而避免多个线程同时访问共享资源时引发的线程安全问题。</p> <h2 id="_2、synchronized作用和使用场景"><a href="#_2、synchronized作用和使用场景" class="header-anchor">#</a> 2、synchronized作用和使用场景</h2> <h3 id="作用"><a href="#作用" class="header-anchor">#</a> 作用</h3> <p>保证线程安全。<br>
由于synchronized的同步机制，能够确保同一时刻只有一个线程可以执行某个代码块， 所以可以保证并发场景下的原子性，有序性，可见性。</p> <h3 id="使用场景"><a href="#使用场景" class="header-anchor">#</a> 使用场景</h3> <h3 id="_1、用在代码块上-类级别同步"><a href="#_1、用在代码块上-类级别同步" class="header-anchor">#</a> ①、用在代码块上(类级别同步)</h3> <p>示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestA</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">TestA</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">TestA</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4000</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>上面例子使用的是类级别的锁（<code>synchronized (TestA.class)</code>），即TestA的Class对象, 类级别的锁粒度较大。<br>
对于类级别的同步，使用类对象（如 <code>TestA.class</code>）或静态变量（如 <code>private static final Object lock = new Object();</code>）作为锁对象，确保所有实例共享同一个锁。</p> <p><strong>补充知识点</strong>(后续整理JVM相关知识点会详细说到)：<br>
在同一个类加载器下，对于同一个类，Class对象是唯一的(所以我们上面可以使用<code>TestA.class</code>作为类级别的锁)。<br>
TestA.class文件中的类只是通过默认的类加载路径被加载，而不涉及自定义类加载器，那么在整个JVM运行期间，无论创建多少个TestA类的对象，TestA.class对应的Class对象都是同一个。
但是，不同的类加载器可以产生不同的Class对象，即使它们加载的类的字节码是相同的。</p> <h3 id="_2、用在代码块上-对象级别同步"><a href="#_2、用在代码块上-对象级别同步" class="header-anchor">#</a> ②、用在代码块上(对象级别同步)</h3> <p>示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestA</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">TestA</span> testA1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                testA1<span class="token punctuation">.</span><span class="token function">counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">TestA</span> testA2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                testA2<span class="token punctuation">.</span><span class="token function">counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>testA1<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2000</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>testA2<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2000</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>对于对象级别的同步，使用实例变量<code>private final Object lock = new Object();</code>作为锁对象，确保每个实例独立同步。</p> <h3 id="_3、用在普通方法上-对象级别同步"><a href="#_3、用在普通方法上-对象级别同步" class="header-anchor">#</a> ③、用在普通方法上(对象级别同步)</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestA</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">TestA</span> testA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                testA<span class="token punctuation">.</span><span class="token function">counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                testA<span class="token punctuation">.</span><span class="token function">counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>testA<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>synchronized修饰普通方法，它隐式地以调用该方法的对象作为锁对象,即隐含的锁对象是<code>this</code>关键字所指的对象，在上面的例子中就是 <code>testA</code>对象。<br>
synchronized修饰普通方法相当于对象锁。对于上面的例子，锁的范围仅限于TestA的具体实例testA。</p> <h3 id="_4、用在静态方法上-类级别同步"><a href="#_4、用在静态方法上-类级别同步" class="header-anchor">#</a> ④、用在静态方法上(类级别同步)</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestA</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><p>synchronized修饰静态方法，隐含的锁对象是类的 Class 对象实例，在上面的例子中就是 <code>TestA.class</code>对象。
当synchronized修饰静态方法时，锁作用于整个类的所有实例。</p> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结：</h3> <p>①、synchronized关键字用在代码块上，锁是synchonized括号里配置的对象，可以实现类级别的同步(使用类的Class对象作为锁，或者使用静态实例变量作为锁)。 也可以实现对象级别的同步(使用类的实例变量作为锁)。
②、synchronized关键字用在普通方法上，可以实现对象级别的同步，隐式地以调用该方法的对象作为锁对象,即隐含的锁对象是<code>this</code>关键字所指的对象。<br>
③、synchronized关键字用在静态方法上，可以实现类级别的同步，隐含的锁对象是类的 Class 对象实例。</p> <p><strong>补充：</strong><br>
synchronized关键字不能用在构造方法上，构造方法本身由JVM保证线程安全，但是不保证构造方法中使用的共享变量的线程安全，我们可以利用final修饰构造方法中使用的共享变量，达到线程安全的目的。final关键字在线程安全的应用(后面另写一篇文章总结)。</p> <h2 id="_3、synchronized底层原理-jvm层面"><a href="#_3、synchronized底层原理-jvm层面" class="header-anchor">#</a> 3、synchronized底层原理（JVM层面）</h2> <p>上面说了三种synchronized关键字的使用方式，都提到了锁，而且只有synchronized关键字用在代码块上我们显示的给了一个对象作为锁，代码块或者方法执行完毕了，我们也不需要释放锁。</p> <p>下面我们看看synchronized到底是怎样使用锁，以及怎么释放锁的。</p> <h3 id="idea配置javap工具查看字节码"><a href="#idea配置javap工具查看字节码" class="header-anchor">#</a> IDEA配置javap工具查看字节码</h3> <p><strong>配置：</strong></p> <img src="/blog/images/32-1.png" alt="mixureSecure"> <p>除了-v   还有其他参数可以使用：<br>
-c：显示方法的字节码指令。
-s：显示字段和方法的内部类型签名。
-v：输出详细信息，包括常量池、方法、字段等的修饰符和属性。
-l：显示行号和局部变量表，便于调试和理解字节码与源代码的对应关系。</p> <p>这些参数也可以一起使用。  (推荐都加上，输入更详细的信息)</p> <img src="/blog/images/32-2.png" alt="mixureSecure"> <p><strong>使用：</strong></p> <img src="/blog/images/32-3.png" alt="mixureSecure"> <h3 id="查看同步代码块的字节码"><a href="#查看同步代码块的字节码" class="header-anchor">#</a> 查看同步代码块的字节码</h3> <p><strong>查看下下面这段Java代码生成的字节码内容</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestA</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">TestA</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token comment">// ...</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>同步代码块字节码：</strong><br>
下面只截取了一部分字节码。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Code</span><span class="token operator">:</span>
   stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>
      <span class="token number">0</span><span class="token operator">:</span> ldc           #<span class="token number">2</span>                  <span class="token comment">// class TestA</span>
      <span class="token number">2</span><span class="token operator">:</span> dup
      <span class="token number">3</span><span class="token operator">:</span> astore_1
      <span class="token number">4</span><span class="token operator">:</span> monitorenter
      <span class="token number">5</span><span class="token operator">:</span> aload_1
      <span class="token number">6</span><span class="token operator">:</span> monitorexit
      <span class="token number">7</span><span class="token operator">:</span> <span class="token keyword">goto</span>          <span class="token number">15</span>
     <span class="token number">10</span><span class="token operator">:</span> astore_2
     <span class="token number">11</span><span class="token operator">:</span> aload_1
     <span class="token number">12</span><span class="token operator">:</span> monitorexit
     <span class="token number">13</span><span class="token operator">:</span> aload_2
     <span class="token number">14</span><span class="token operator">:</span> athrow
     <span class="token number">15</span><span class="token operator">:</span> <span class="token keyword">return</span>
</code></pre></div><h3 id="分析同步代码块字节码"><a href="#分析同步代码块字节码" class="header-anchor">#</a> 分析同步代码块字节码</h3> <p>这里仅分析字节码中  <code>monitorenter</code> 和 <code>monitorexit</code> 这两个JVM指令。<br> <code>monitorenter</code>和 <code>monitorexit</code> 是 Java 虚拟机（JVM）指令集中的两个特殊指令，它们用于实现 Java 中synchronized 关键字的同步机制。</p> <p>在 Java源代码编译阶段（javac 编译），编译器遇到由 synchronized 关键字修饰的方法或代码块时，它会在字节码(.class文件)级别生成相应的 monitorenter 和 monitorexit 指令。
<strong>其中：</strong><br> <code>monitorenter 指令</code>：会被插入到 synchronized 块的开始处，以及 synchronized 方法的入口。它的作用是尝试获取对象的内部锁（监视器锁）。如果锁未被占用，则当前线程可以获得锁并继续执行；如果锁已被其他线程占用，则当前线程将被阻塞，直到锁被释放。</p> <p><code>monitorexit 指令</code>：会被插入到 synchronized 块的结束处，以及可能抛出异常的路径上（确保即使发生异常也能释放锁）。当线程执行完 synchronized 块的代码或抛出异常时，monitorexit 指令会释放之前获取的锁，允许其他等待的线程有机会获取锁并进入同步块。</p> <p>画个图演示下 <code>monitorenter</code> 和 <code>monitorexit</code> 流程：</p> <img src="/blog/images/32-4.png" alt="mixureSecure"> <p>这里的所计数器操作涉及到锁重入的概念。 下面第5点 有详细介绍。</p> <h3 id="查看同步方法的字节码"><a href="#查看同步方法的字节码" class="header-anchor">#</a> 查看同步方法的字节码</h3> <p><strong>查看下下面这段Java代码生成的字节码内容</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestA</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;synchronized修饰方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>同步方法字节码：</strong><br>
下面只截取了一部分字节码。</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">V</span>
    flags<span class="token operator">:</span> <span class="token constant">ACC_PUBLIC</span><span class="token punctuation">,</span> <span class="token constant">ACC_SYNCHRONIZED</span>
    <span class="token class-name">Code</span><span class="token operator">:</span>
      stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span><span class="token operator">:</span> getstatic     #<span class="token number">2</span>                  <span class="token comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span>
         <span class="token number">3</span><span class="token operator">:</span> ldc           #<span class="token number">3</span>                  <span class="token comment">// String synchronized ����</span>
         <span class="token number">5</span><span class="token operator">:</span> invokevirtual #<span class="token number">4</span>                  <span class="token comment">// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
         <span class="token number">8</span><span class="token operator">:</span> <span class="token keyword">return</span>
      <span class="token class-name">LineNumberTable</span><span class="token operator">:</span>
        line <span class="token number">3</span><span class="token operator">:</span> <span class="token number">0</span>
        line <span class="token number">4</span><span class="token operator">:</span> <span class="token number">8</span>
      <span class="token class-name">LocalVariableTable</span><span class="token operator">:</span>
        <span class="token class-name">Start</span>  <span class="token class-name">Length</span>  <span class="token class-name">Slot</span>  <span class="token class-name">Name</span>   <span class="token class-name">Signature</span>
            <span class="token number">0</span>       <span class="token number">9</span>     <span class="token number">0</span>  <span class="token keyword">this</span>   <span class="token class-name">LTestA</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="分析同步方法字节码"><a href="#分析同步方法字节码" class="header-anchor">#</a> 分析同步方法字节码</h3> <p>synchronized 修饰方法是通过 <code>ACC_SYNCHRONIZED</code> 标识来实现方法级别的同步。<code>ACC_SYNCHRONIZED</code> 是Java类文件中方法的访问标志之一，用来标识方法是否被 synchronized 关键字修饰。指示该方法在执行时会获取对象的监视器，其他线程需要等待锁的释放才能执行该方法的代码。</p> <h3 id="补充知识点-对象头"><a href="#补充知识点-对象头" class="header-anchor">#</a> 补充知识点：对象头</h3> <p>每个 Java 对象实例都有一个对象头（Object Header），对象头包含几部分，分别是:</p> <ul><li><p><strong>Mark Word:</strong>    Mark Word 是对象头的一部分，用于存储对象的运行时数据，如哈希码（HashCode）、GC 分代年龄（Generational GC age）、锁状态标志、线程持有的锁、偏向线程 ID 等。Mark Word 是一个非常灵活的结构，在不同的对象状态下会有不同的表示方式。下面会说明。</p></li> <li><p><strong>Klass Pointer:</strong>  这部分存储的是对象所属类的元数据指针。通过这个指针，可以找到对象的类信息，包括类的名字、父类、方法表等。</p></li> <li><p><strong>Array length:</strong> 这个部分只存在于数组对象中，用于存储数组的长度。只有数组对象才有这部分内容。
对于普通对象：对象头包括Mark Word、Klass Pointer。<br>
对于数组对象：对象头包括Mark Word、Klass Pointer、Array length。</p></li></ul> <p><strong>Mark Word在不同的对象状态下会有不同的表示方式:</strong><br>
下表是64位JVM下的 Mark Word 各个位储存的数据变化情况(参考了一些资料整理的表格可能不够准确，如果有问题欢迎指正)</p> <img src="/blog/images/32-5.png" alt="mixureSecure"> <p><strong>解释下上面偏向锁的ThreadID和Epoch（先留个印象，下面锁升级过程会详细介绍）</strong><br> <strong>ThreadID（54bit）</strong><br>
ThreadID 存储持有偏向锁的线程的唯一标识符（ID）。偏向锁的设计目的是为了在无竞争的情况下减少同步的开销。当一个对象第一次被一个线程获取时(必须是一个线程，且对象是匿名偏向状态)，会在 Mark Word 中记录该线程的 ID，以表示该对象偏向于该线程。</p> <p><strong>作用:</strong> 当该线程再次进入同步块时，如果对象的 Mark Word 中的 ThreadID 与当前线程的 ID 匹配，线程就可以直接进入，而无需进行任何同步操作，从而提高了性能。</p> <p><strong>Epoch（2bit）</strong><br>
Epoch 是一个用于表示偏向锁的时间戳或时期的字段。它用来区分不同时间段内的偏向锁，避免出现锁膨胀和长时间持有偏向锁的问题。</p> <p><strong>作用:</strong> Epoch 字段在某些情况下会被更新，例如当偏向锁被撤销时，Epoch 会增加，这样可以防止旧的偏向锁信息干扰新的偏向锁。它确保偏向锁机制能够正常工作，并在需要时重新分配偏向锁。</p> <p><strong>指向线程栈中锁记录的指针：</strong><br>
当一个线程尝试获取轻量级锁时，JVM 会在该线程的栈中创建一个锁记录（Lock Record）。<br>
锁记录用于存储 Mark Word 的拷贝以及其他锁状态信息。线程尝试将对象头中的 Mark Word 替换为指向线程栈中锁记录的指针。
替换操作通过 CAS 完成，以确保操作的原子性。<br>
如果 CAS 操作成功，Mark Word 中存储的就是指向线程栈中锁记录的指针，此时线程获得轻量级锁。<br>
Mark Word 的内容变为指向锁记录的指针，同时锁记录中保存原始的 MarkWord。<br>
(说人话就是，对象头Mark Word只有几个字节的空间，存不下轻量级锁的信息了，所以把锁的信息和原Mark Word里信息放到线程栈里面去存一个锁记录，Mark Word只存这个锁记录的指针方便快速获取锁记录的详细信息)</p> <p><strong>指向重量级锁的指针：</strong><br>
当锁膨胀为重量级锁时，JVM在堆中创建一个监视器对象用于管理锁的信息。<br>
对象头中的Mark Word更新为指向监视器对象的指针。<br>
通过这个指针，线程可以访问并操作重量级锁的详细信息。</p> <h3 id="monitor-监视器"><a href="#monitor-监视器" class="header-anchor">#</a> Monitor（监视器）</h3> <p>在Java中，每一个对象都有一个关联的监视器，这个监视器用于实现线程同步。监视器是一个结构，它包含了一些用于控制线程访问共享资源的数据和逻辑。</p> <p><strong>监视器的功能：</strong>
同步方法和代码块：监视器用于实现同步方法和synchronized代码块。当一个线程进入一个同步方法或同步代码块时，它必须首先获得该对象的监视器。<br>
线程管理：监视器负责管理等待和通知机制（wait/notify/notifyAll），使得线程可以在条件不满足时等待，条件满足时被唤醒。</p> <h3 id="监视器锁"><a href="#监视器锁" class="header-anchor">#</a> 监视器锁</h3> <p>监视器锁是监视器的一部分，确保同一时间只有一个线程能够执行同步代码块或同步方法。每个对象都有一个隐式的监视器锁，当线程需要进入一个同步代码块或方法时，它必须先获得这个锁。</p> <p><strong>监视器锁的工作过程：</strong><br> <strong>获取锁：</strong> 当一个线程进入synchronized方法或代码块时，它尝试获取监视器锁。如果锁被其他线程持有，则该线程会被阻塞，直到锁被释放。 <strong>( 监视器锁在有些资料上也叫内置锁，属于X锁(即排他锁)  )</strong></p> <p><strong>释放锁：</strong> 当线程退出synchronized方法或代码块时，它会释放监视器锁，允许其他被阻塞的线程获取锁并执行同步代码。</p> <p><strong>重入锁：</strong> Java的监视器锁是可重入锁，这意味着如果一个线程已经持有了一个监视器锁，它可以再次进入由同一个监视器保护的同步代码，而不会被阻塞。</p> <h3 id="synchronized到底锁的是哪个对象"><a href="#synchronized到底锁的是哪个对象" class="header-anchor">#</a> synchronized到底锁的是哪个对象？</h3> <p>synchronized表面上给使用者的感觉是代码块或者函数之间形成了互斥，同一时间只能有一个线程可以执行到synchronized修饰的代码块或者函数。这是synchronized表面给使用者最直观的感觉。</p> <p>但是实际上synchronized是给对象加了锁。当一个线程进入synchronized方法或代码块时，就会去获取这个对象的锁，上面说了这个锁叫监视器锁。  下面我们来分析下锁到底加在了哪个对象上。</p> <p>①、对于静态成员函数，锁是加在类的Class对象上面的。相当于代码块的<code>synchronized (TestA.class)</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestA</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">TestA</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token comment">// 锁的是 TestA.class 这个对象</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">aa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//  锁的也是 TestA.class 这个对象</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>②、对于非静态成员函数，锁是加在this对象上面的。相当于代码块的<code>synchronized (this)</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">aa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token comment">//  锁的是 this 这个对象</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
    
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">bb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token comment">//  锁的也是 this 这个对象</span>
 <span class="token punctuation">}</span>
</code></pre></div><h3 id="让秀逗告诉你锁的本质-通俗点的例子"><a href="#让秀逗告诉你锁的本质-通俗点的例子" class="header-anchor">#</a> 让秀逗告诉你锁的本质(通俗点的例子)</h3> <p><strong>通俗点的例子：</strong>
一个比较形象的比喻，锁相当于狗狗王国里的五星上将秀逗(也就是狗狗王国的保安)，并且这个叫秀逗的狗狗非常称职它是35岁的程序员再就业少走20年弯路应聘上的狗狗王国的保安。
秀逗深谙互斥锁的道理，秀逗把都每个回家的狗狗都当成一个线程，这对于曾经做过程序员的秀逗来说简直小菜一碟，每个狗狗想通过狗狗王国大门前的门禁，都必须得到秀逗的许可，秀逗认为自己就是一把锁，大门的门禁就是秀逗锁住的代码块或者函数，同一时刻，秀逗只允许一只狗狗走过门禁。<br>
这个时候大黄来了，秀逗说，站住，你必须等前面的四眼走完门禁的这段路你才能进去。于是大黄只能乖乖等四眼走过去之后，才能继续进入门禁。</p> <p>上面的例子，秀逗是锁，大黄和四眼就是线程，门禁就是同步代码块，或者同步的方法。</p> <p><strong>程序员的角度：</strong><br>
从程序员的角度来看，锁就是一个“对象”，这个对象要完成一些事情：<br>
①、需要记录当前有没有线程获得锁。 (比如上面说的，秀逗不让大黄进入门禁，因为现在门禁里面还有狗狗没走完)<br>
②、需要记录当前获得锁的是哪个线程。（秀逗得知道目前正在通过门禁的是四眼）
③、需要记录还有哪些线程在阻塞等待获取锁。(秀逗得知道后面还有多个狗狗在排队等待进入门禁)</p> <p>那么我们把这个锁对象单独拎出来实现上面说的三个功能。我们就可以把这个对象放到 synchronized () 的括号里作为锁。<br>
比如，上面的秀逗可以作为锁，把秀逗当成锁对象：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>秀逗<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 需要同步访问的代码</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个时候狗狗王国里面的物业经理二哈看秀逗工作轻松，每月轻轻松松月入2千，根本花不完，二哈不乐意了，二哈觉得既然秀逗可以当锁对象，那四眼，大黄也能当，只要四眼，大黄或者其他什么狗狗，都掌握上面说的三点技能：<br>
①、需要记录当前有没有线程获得锁。<br>
②、需要记录当前获得锁的是哪个线程。<br>
③、需要记录还有哪些线程在阻塞等待获取锁。<br>
那么任何一个狗狗都能当锁。</p> <p>二哈觉得这个主意不错，以后让狗狗们自己都掌握锁对象的技能，然后走门禁的时候，谁正在门禁内谁就是锁对象，后面的狗狗就得排队。<br>
至此，秀逗掌握的技能，其他狗狗都掌握了。狗狗王国也不需要秀逗这个保安了，因为狗狗王国里面的每个狗狗对象现在都掌握了锁的技能，它们每个人都可以当保安(锁对象)。 这样门禁的管理更方便了。</p> <p>只有秀逗默默流下了泪水~</p> <img src="/blog/images/32-6.png" alt="mixureSecure"> <p>好，秀逗的故事说完了，我们再来说一下Java中的锁。</p> <p>上面说了锁也是对象，并且我们的共享资源(比如变量、代码块、方法等)本身也属于对象的一部分。 于是Java语言就把锁和线程要访问的共享资源对象合二为一。 让Java中每个对象都能作为锁，这样synchronized就能够把任意对象当做锁来用。</p> <p>为了实现每个对象都能作为锁这个目的，于是就有了对象头中的Mark Word以及与对象关联的Monitor，当然Mark Word结合Monitor能干的事情包含但不限于下面这三点：<br>
①、需要记录当前有没有线程获得锁。<br>
②、需要记录当前获得锁的是哪个线程。<br>
③、需要记录还有哪些线程在阻塞等待获取锁。</p> <p>是不是到这儿就豁然开朗了。</p> <p><strong>最后总结下这个例子：</strong></p> <p><strong>锁的比喻：</strong><br> <strong>秀逗：</strong> 代表锁。作为狗狗王国的保安，秀逗控制狗狗们（线程）通过门禁（同步代码块或方法）。<br> <strong>大黄和四眼：</strong> 代表线程。它们需要等待秀逗（锁）许可才能通过门禁（同步代码块或方法）。</p> <p><strong>锁的功能：</strong>
记录当前有没有线程获得锁：秀逗控制同一时刻只允许一个狗狗通过门禁。<br>
记录当前获得锁的线程：秀逗知道当前正在通过门禁的是哪个狗狗（线程）。<br>
记录等待获取锁的线程：秀逗知道哪些狗狗在排队等候通过门禁。</p> <p><strong>锁对象的实现：</strong><br>
任何狗狗都可以作为锁对象，只要掌握了记录当前锁状态、当前锁定线程和等待线程的技能。<br>
在Java中，锁对象与共享资源对象合二为一，每个对象都能作为锁，通过synchronized关键字实现同步。</p> <p><strong>Mark Word和Monitor的作用：</strong><br>
记录锁的状态：当前有没有线程获得锁。<br>
记录获得锁的线程：当前获得锁的是哪个线程。<br>
记录等待获取锁的线程：哪些线程在等待获取锁。<br>
还有一些其他功能，比如记录获取锁后又释放锁进入等待状态的线程等。</p> <h3 id="java中为什么要设计成全员皆锁"><a href="#java中为什么要设计成全员皆锁" class="header-anchor">#</a> Java中为什么要设计成<code>全员皆锁</code></h3> <p>下面总结了几个方面的原因：</p> <ol><li><p>简化同步机制<br>
在Java中，每个对象都可以作为锁，这使得同步机制变得非常简单和直观。程序员可以使用任何对象来实现同步，而不需要额外的锁对象。这种设计避免了创建和管理独立锁对象的复杂性。</p></li> <li><p>统一的锁定模型<br>
统一的锁定模型意味着每个对象都有相同的同步行为和机制。程序员不需要记住额外的规则或模式来使用锁，因为所有对象都可以用于同步。只需使用synchronized关键字即可。</p></li> <li><p>提高灵活性<br>
由于每个对象都可以作为锁，程序员可以根据具体的需求选择合适的对象进行同步。这样，能够更灵活地设计同步逻辑。例如，可以使用方法所在的对象（this）作为锁，也可以使用类的静态成员作为锁。</p></li> <li><p>提高代码可读性和可维护性<br>
在代码中使用共享资源所在的对象进行同步（例如，使用共享资源对象本身）可以提高代码的可读性和可维护性。这样，读代码的人可以很容易地理解同步的意图，而不需要去寻找额外的锁对象。</p></li> <li><p>效率优化<br>
Java虚拟机（JVM）可以对锁的实现进行多种优化，例如偏向锁、轻量级锁和重量级锁的不同优化策略。这些优化可以在不改变程序员使用锁的方式的情况下提高性能。</p></li> <li><p>支持细粒度锁定<br>
通过让每个对象都可以作为锁，Java允许程序员使用细粒度的锁定策略，以减少锁争用和提高并发性能。例如，可以为不同的资源使用不同的锁对象，从而实现更高效的并发控制。</p></li></ol> <p>上面都是比较书面的表达：说人话就是 这样设计简单方便、灵活好用，方便(JVM)优化。就像为synchronized打广告一样~</p> <h2 id="_4、synchronized和wait、notify"><a href="#_4、synchronized和wait、notify" class="header-anchor">#</a> 4、synchronized和wait、notify</h2> <h3 id="首先需要先明确一个问题"><a href="#首先需要先明确一个问题" class="header-anchor">#</a> 首先需要先明确一个问题：</h3> <h3 id="为什么wait-和notify-方法必须和synchronized一起使用"><a href="#为什么wait-和notify-方法必须和synchronized一起使用" class="header-anchor">#</a> 为什么<code>wait()</code>和<code>notify()</code>方法必须和synchronized一起使用？</h3> <p>要回答这个问题我们需要先明确<code>wait()</code>和<code>notify()</code>方法的作用：<strong>线程通信</strong>。而且要保证线程通信的正确性。</p> <p><strong>wait()：</strong> 当一个线程执行wait()时，它会放弃持有的对象锁并进入该对象的等待队列中，直到其他线程调用notify()或notifyAll()唤醒它。线程被唤醒后，需要重新获得对象的锁才能继续执行。</p> <p><strong>notify()：</strong> 当一个线程执行notify()时，它会随机唤醒在该对象等待队列中等待的一个线程（如果有的话）。被唤醒的线程会尝试重新获得对象的锁，成功后继续执行。</p> <p><strong>notifyAll()：</strong> 唤醒所有在该对象等待队列中等待的线程。被唤醒的线程会依次尝试重新获得对象的锁，成功后继续执行。</p> <p>假如不在synchronized中使用<code>wait()</code>和<code>notify()</code>方法会怎么样呢？</p> <p>看下面的例子：<br>
我使用两个线程分别执行两个方法，这两个方法都使用同一个对象分别调用了<code>wait()</code>和<code>notify()</code>，并且没使用synchronized同步。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestA</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">TestA</span> testA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                testA<span class="token punctuation">.</span><span class="token function">aa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            testA<span class="token punctuation">.</span><span class="token function">bb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">aa</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">bb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><p>执行结果：<br>
抛了异常 <code>IllegalMonitorStateException</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code>Exception <span class="token keyword">in</span> thread <span class="token string">&quot;Thread-0&quot;</span> Exception <span class="token keyword">in</span> thread <span class="token string">&quot;Thread-1&quot;</span> java.lang.IllegalMonitorStateException
</code></pre></div><p>可以想像一下，上面两个线程之间通信，但是对于同一个对象this(指向的是testA对象)来说，一个方法要等待，一个要唤醒。<br>
这个种操作本身就需要同步，如果没有同步就会出现线程安全问题。
比如上面代码就可能出现一种情况：  notify() 是在 wait() 之前调用的（没有同步，无法保证线程执行的顺序），则等待的线程可能会永远等待，而导致死锁等线程安全问题。</p> <p>所以说：<br>
Java 明确要求 <code>wait()</code>、<code>notify()</code> 和 <code>notifyAll()</code> 必须在持有对象监视器的前提下调用，即这些方法必须在同步块或同步方法中调用，否则会抛出 <code>IllegalMonitorStateException</code> 异常。</p> <p>现在我们再思考一个之前在Java基础知识中提到过的一个小知识点：<br>
为什么 <code>wait()</code>、<code>notify()</code> 和 <code>notifyAll()</code> 是和线程通信相关的方法，却放在了Object类中定义？<br>
相信通过上面的讲解，对于这个问题就有非常明确的答案了，之前我在<a href="https://blog.csdn.net/qq_37883866/article/details/140047490" target="_blank" rel="noopener noreferrer">Java基础知识点<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>这篇文章中说，因为锁可以是任意的对象，所以<code>wait()</code>、<code>notify()</code> 和 <code>notifyAll()</code>这些方法只有放在所有类的父类Object中才能满足锁可以是任意的对象这个条件。<br>
现在再结合上面对于 对象头Mark Word、对象监视器，监视器锁的讲解，应该能对这个问题会有更深刻的理解。</p> <h3 id="等待监视器锁的线程放在哪儿了-引出生产者-消费者模式"><a href="#等待监视器锁的线程放在哪儿了-引出生产者-消费者模式" class="header-anchor">#</a> 等待监视器锁的线程放在哪儿了？引出生产者-消费者模式</h3> <p>等待监视器锁的线程通常放在对象的监视器（Monitor）的等待队列中。Java中每个对象都有一个监视器，负责管理锁的状态和线程的同步。</p> <p>去瞅一眼JVM源码对<code>wait()</code>、<code>notify()</code>的注释：（关于JVM源码的下载可以看下之前的文章 <a href="https://blog.csdn.net/qq_37883866/article/details/140112486" target="_blank" rel="noopener noreferrer">Java中volatile关键字详解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</p> <p>查看 <code>objectMonitor.cpp</code> 和<code>objectMonitor.hpp</code>这两个C++源码文件。<br>
下面是objectMonitor的构造函数：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token function">ObjectMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _WaitSet      <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    _cxq          <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
    _EntryList    <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
<span class="token comment">// ... 省略其他</span>
  <span class="token punctuation">}</span>
</code></pre></div><p><strong>_cxq:</strong>
_cxq 是 ObjectMonitor 类的一个成员变量，表示竞争队列（Contended Queue）。
在多线程环境中，当有多个线程竞争获取同一个对象的锁时，它们会被放置在 _cxq 中等待获取锁。
_cxq 中的线程会在锁释放时被移动到 _EntryList 中。</p> <p><strong>_EntryList:</strong>
_EntryList 是 ObjectMonitor 类的另一个成员变量，表示进入列表（Entry List）。
当一个线程成功获取对象的锁时，它会从 _EntryList 中移除。
如果有多个线程等待获取锁，它们会按照一定的策略（如 FIFO）被放置在 _EntryList 中等待。</p> <p><strong>_WaitSet:</strong>
_WaitSet 是 ObjectMonitor 类的成员变量，表示等待集合（Wait Set）。
当线程调用对象的 wait() 方法时，它会释放对象的锁并进入 _WaitSet 等待状态。
当其他线程调用对象的 notify() 或 notifyAll() 方法时，会从 _WaitSet 中选择一个或多个线程移动到 _EntryList 或 _cxq 中。</p> <p>这和我这篇文章中 <a href="https://blog.csdn.net/qq_37883866/article/details/139739625" target="_blank" rel="noopener noreferrer">BlockingQueue详解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中利用阻塞队列实现线程同步的思想其实是一致的。</p> <p>实际上利用队列实现通知机制的思想是一种经典的并发编程模式，它通过队列作为中介，实现了多线程之间的解耦和通信。<br>
我们常见的线程池任务分发、消息队列、事件驱动等都是利用的这个思想。<br>
那这个模式书面名称叫啥呢?  没错就是大名鼎鼎的<code>Producer-Consumer Pattern</code>(生产者-消费者模式).</p> <h2 id="_5、synchronized监视器锁可重入原理"><a href="#_5、synchronized监视器锁可重入原理" class="header-anchor">#</a> 5、synchronized监视器锁可重入原理</h2> <p>可重入锁指的是同一个线程在持有锁的情况下，可以多次进入同步代码块或同步方法，而不会因为自己已经持有锁而阻塞。</p> <p>synchronized可重入性的实现主要依赖于每个对象的监视器锁（monitor lock）和线程的线程栈帧中的锁计数器（lock count）：</p> <p>需要注意：<br>
在 Java 中，线程的锁计数器（lock count）是针对监视器锁（monitor lock）的，也就是使用 synchronized 关键字获取的锁。这种锁计数器仅适用于监视器锁，而不适用于其他类型的锁，比如 ReentrantLock 或者其他自定义的锁实现。</p> <ul><li>当一个线程进入同步代码块或同步方法时，会尝试获取对象的监视器锁。</li> <li>如果对象的监视器锁未被其他线程持有，当前线程将获取到锁，并将锁计数器设置为1。</li> <li>如果当前线程已经持有了对象的监视器锁，那么在锁计数器上递增。</li> <li>当线程退出同步代码块或同步方法时，锁计数器会递减。</li> <li>当锁计数器递减为0时，表示当前线程已经完全释放了对象的监视器锁，其他等待线程可以尝试获取锁。</li></ul> <p>例如：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestA</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TestA</span> testA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                testA<span class="token punctuation">.</span><span class="token function">aa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">aa</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">&quot;线程执行了aa方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>结果：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>t1线程执行了aa方法
t1线程执行了aa方法
t1线程执行了aa方法
</code></pre></div><p>t1线程执行了三次synchronized 修饰的aa方法，实际上只需要第一次获取testA对象的监视器锁即可，后面执行都是锁重入。</p> <h2 id="动画总结synchronized-监视器锁原理"><a href="#动画总结synchronized-监视器锁原理" class="header-anchor">#</a> 动画总结synchronized 监视器锁原理：</h2> <p>通过上面的整理梳理应该能大致理解synchronized的锁原理了。<br>
这里再画个动画，来梳理下多个线程调用synchronized代码块或者方法，获取和释放或者等待的过程, 帮助理解。<br>
这里就不截图了，眨眼补帧吧。哈哈~</p> <img src="/blog/images/32-7.gif" alt="mixureSecure"> <p>调用 wait() 和 notify() 需要用到_WaitSet队列，动画没画，可以自行脑补一下。 因为画这玩意儿太费时间了，我偷懒了~<br>
这里copy一张其他博客上的图来说明这几个队列之间数据的流转：<br> <a href="https://tech.youzan.com/javasuo-yu-xian-cheng-de-na-xie-shi/" target="_blank" rel="noopener noreferrer">下面张图片来源https://tech.youzan.com/javasuo-yu-xian-cheng-de-na-xie-shi/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <img src="/blog/images/32-8.png" alt="mixureSecure"> <h2 id="_6、synchronized锁升级过程"><a href="#_6、synchronized锁升级过程" class="header-anchor">#</a> 6、synchronized锁升级过程</h2> <p>先回答一个问题。 为什么在JDK6当中优化了监视器锁。<br>
（先来段废话文学~）<br>
因为JDK6之前的锁性能低。通过JDK6当中优化了许多锁的技术细节提高了获取和释放锁整体操作的性能。</p> <p>好了忘记上面的废话文学吧，还是来点靠谱的分析吧。</p> <h3 id="补充知识点"><a href="#补充知识点" class="header-anchor">#</a> 补充知识点：</h3> <p>上面我们已经分析了synchronized监视器锁在JVM层面的原理。<br>
下面我们继续往底层探索探索。</p> <p>Java代码的synchronized关键字在编译成.class字节码时，会生成<code>monitorenter</code> 和 <code>monitorexit</code> 指令。</p> <p><strong>在 JVM 层面：</strong> monitorenter 和 monitorexit 指令用于实现监视器锁。每个对象都有一个与之关联的监视器锁，当一个线程进入同步代码块时，它会尝试获取对象的监视器锁，如果成功，则进入同步块；否则，该线程会阻塞，直到获得锁。</p> <p><strong>在操作系统层面：</strong> JVM 的监视器锁最终依赖操作系统提供的同步机制。以 x86-64(AMD64) 架构处理器和 Windows 64 位操作系统为例，JVM 的锁实现会依赖于操作系统提供的 Mutex Lock 来实现线程之间的互斥访问。</p> <p><strong>在处理器硬件层面：</strong> 比如x86-64 架构处理器提供了原子操作指令（如 lock cmpxchg 和 lock xchg），这些指令能够在多核处理器环境中确保某些操作的原子性、可见性、有序性，防止并发访问导致的数据竞争。本质上就是lock前缀指令，可以去看 我的这篇文章<a href="https://deepjava.blog.csdn.net/article/details/140112486" target="_blank" rel="noopener noreferrer">volatile关键字详解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，里面有介绍lock前缀指令。</p> <h3 id="mutex-lock-互斥锁"><a href="#mutex-lock-互斥锁" class="header-anchor">#</a> Mutex Lock（互斥锁）：</h3> <p>Mutex Lock（互斥锁）是一种同步机制，用于确保在多线程或多进程环境中，同一时刻只有一个线程（或进程）可以访问共享资源。它是通过操作系统提供的原语（如特殊的CPU指令或者操作系统的内核功能）来实现的。<br>
Mutex Lock是操作系统的内核层功能。</p> <h3 id="内核态和用户态"><a href="#内核态和用户态" class="header-anchor">#</a> 内核态和用户态：</h3> <p><strong>CPU硬件层面：</strong><br> <strong>内核态（Kernel Mode）：</strong> CPU可以执行所有指令，包括特权指令。CPU可以访问所有的内存地址和硬件设备。这个模式用于操作系统内核和一些关键的系统级服务。
<strong>用户态（User Mode）：</strong> CPU只能执行非特权指令，受限于访问内存和硬件设备。用户态用于运行应用程序，以保护系统不受用户程序错误或恶意行为的影响。</p> <p><strong>操作系统软件层面：</strong><br> <strong>内核态：</strong> 操作系统内核运行在CPU的内核态下，以便能够执行特权指令和访问所有资源。内核态下运行的代码包括设备驱动程序、文件系统、网络协议栈等。
<strong>用户态：</strong> 应用程序运行在CPU的用户态下。操作系统通过提供系统调用接口，允许用户态程序请求内核态服务，如文件读写、进程管理、网络通信等。</p> <p><strong>为什么需要内核态和用户态的区分？</strong><br>
可以从以下几个方面来看：<br>
安全性：CPU内核态和用户态的区分可以防止用户程序直接访问和控制系统核心资源，从而保护系统的稳定性和安全性。<br>
稳定性：CPU内核态运行的代码（如操作系统的内核代码）具有更高的权限，可以执行特权指令，管理系统资源，确保系统的稳定运行。<br>
资源管理：CPU内核态负责资源的分配和管理，通过系统调用提供受控的接口给用户态程序访问。</p> <h3 id="内核态和用户态的切换"><a href="#内核态和用户态的切换" class="header-anchor">#</a> 内核态和用户态的切换：</h3> <p>在程序运行过程中，当用户态程序需要执行特权操作时(比如需要使用Mutex Lock时)，必须通过系统调用切换到CPU的内核态。操作系统内核在处理完CPU内核态的系统调用后，CPU会返回用户态继续执行用户程序。这种切换过程涉及到保存和恢复 CPU 的上下文信息（包括寄存器、程序计数器、堆栈指针等）。</p> <p><strong>切换过程</strong>
用户态到内核态：当用户态程序发起系统调用时，CPU 切换到内核态，操作系统内核处理请求。
内核态到用户态：操作系统内核完成请求后，CPU恢复用户态的上下文，返回用户态继续执行。</p> <p><strong>一个线程下的CPU内核态和用户态的切换：</strong><br> <code>用户态线程执行 --&gt; 系统调用/中断 --&gt; 保存用户态上下文 --&gt; 切换到内核态 --&gt; 执行内核代码 --&gt; 恢复用户态上下文 --&gt; 返回用户态线程执行</code></p> <p><strong>线程上下文切换过程示例：(注意和上面区分)</strong><br> <code>线程 A 执行 --&gt; 保存线程 A 上下文 --&gt; 选择线程 B --&gt; 恢复线程 B 上下文 --&gt; 线程 B 执行</code></p> <h3 id="jdk6之前synchronized为什么性能不好"><a href="#jdk6之前synchronized为什么性能不好" class="header-anchor">#</a> JDK6之前synchronized为什么性能不好</h3> <p>经过上面的铺垫，再总结下这个JDK6之前synchronized为什么性能不好的问题就比较自然了。</p> <ol><li><p>重量级锁（Heavyweight Locking）<br>
实现方式：在JDK6之前，synchronized使用的是基于操作系统的Mutex Lock（互斥锁）进行实现。每次线程进入和退出同步块时，都需要通过调用操作系统的内核函数来获取和释放锁。
内核态和用户态切换：获取和释放锁的过程涉及到CPU从用户态切换到内核态，再从内核态切换回用户态。这种切换需要保存和恢复CPU的上下文信息，开销大。<br>
系统调用开销：每次锁的获取和释放都会进行系统调用，系统调用本身也会带来较大的性能开销。</p></li> <li><p>线程阻塞和唤醒<br>
线程阻塞：当一个线程试图获取一个已经被其他线程持有的锁时，该线程会被阻塞。阻塞操作会导致线程的上下文切换，开销大。<br>
线程唤醒：当锁被释放时，需要唤醒一个被阻塞的线程。唤醒操作同样涉及线程的上下文切换，并且需要操作系统内核进行调度，开销也很大。</p></li></ol> <h3 id="真正的主角登场-jdk1-6对锁的升级"><a href="#真正的主角登场-jdk1-6对锁的升级" class="header-anchor">#</a> 真正的主角登场(JDK1.6对锁的升级)</h3> <h3 id="对锁的优化方式介绍"><a href="#对锁的优化方式介绍" class="header-anchor">#</a> 对锁的优化方式介绍</h3> <p>为了解决JDK中锁机制的性能问题。  JDK1.6对锁进行了一系列的升级操作。
主要有下面这些优化方式：</p> <ul><li>锁粗化</li> <li>自旋锁</li> <li>自适应自旋锁</li> <li>锁消除</li> <li>偏向锁</li> <li>轻量级锁</li></ul> <p>下面分别介绍：<br>
①、锁粗化
通常情况下，建议将同步块的范围尽量缩小，也就是锁粒度尽量缩小，以减少锁的竞争。<br>
然而，如果在一个短时间内，对象被频繁地加锁和解锁，反而会增加性能开销。<br>
锁粗化通过扩展同步块的范围，将多个连续的加锁和解锁操作合并为一个，从而减少锁操作的频率，提升性能。<br>
锁粗化是JVM在即时编译（JIT）期间进行的一种优化，它会自动将多个连续的加锁和解锁操作合并为一个更大的同步块。</p> <p>示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 优化前</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 操作</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 优化后  </span>
<span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 操作</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>②、自旋锁<br>
自旋锁是指线程在短时间内尝试获取锁时，不会立即进行阻塞，而是在循环中不断尝试获取锁。<br>
这样可以避免线程频繁地进入和退出阻塞状态(涉及线程上下文切换)，从而减少线程调度带来的开销。<br>
但如果自旋时间过长，会让CPU空转，会占用CPU资源，反而降低性能。<br>
示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 简单自旋锁示例</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 自旋</span>
<span class="token punctuation">}</span>
</code></pre></div><p>③、自适应自旋锁<br>
自适应自旋锁是自旋锁的改进版本。自适应自旋锁的自旋次数不是固定的，而是根据前一次自旋锁的获取情况以及锁的拥有者的状态来动态调整。自适应自旋锁能够更加智能地选择自旋时间，进一步提升性能。<br>
示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 自适应自旋锁示例（伪代码）</span>
<span class="token keyword">int</span> spins <span class="token operator">=</span> <span class="token function">calculateAdaptiveSpins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> spins <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    spins<span class="token operator">--</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>④、锁消除<br>
锁消除是指JVM在即时编译（JIT）期间，通过对代码的逃逸分析，判断某些同步块所使用的锁对象不会逃逸出线程，从而消除这些不必要的锁操作。这样可以减少不必要的同步开销，提高程序执行效率。<br>
示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 操作</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 优化后  </span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">example</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// JVM会消除不必要的同步操作</span>
    <span class="token comment">// 操作</span>
<span class="token punctuation">}</span>

</code></pre></div><p>⑤、偏向锁<br>
偏向锁是指当一个线程获得锁后，锁进入偏向模式，此时锁会偏向于该线程，如果该线程再次请求同一个锁，便不再进行加锁操作，直接进入同步块，从而减少锁操作的开销。当有其他线程请求该锁时，偏向锁才会被撤销。</p> <p>⑥、轻量级锁<br>
轻量级锁是指当锁处于无竞争或低竞争状态时，线程会通过CAS操作（Compare-And-Swap）将对象头的Mark Word替换为指向线程栈中锁记录的指针。轻量级锁可以避免重量级锁的开销，提高性能。如果出现一定条件的竞争，轻量级锁会膨胀为重量级锁。</p> <p>⑦、重量级锁<br>
重量级锁是通过操作系统的互斥量（Mutex）来实现的，当线程竞争激烈或轻量级锁膨胀时，会使用重量级锁。重量级锁会让线程进入阻塞状态，这样可以避免CPU空转，但会带来较高的线程上下文切换开销。</p> <p><strong>简单总结下：</strong></p> <table><thead><tr><th>优化方式</th> <th>优点</th> <th>缺点</th> <th>适用场景</th></tr></thead> <tbody><tr><td>锁粗化</td> <td>减少锁操作的频率，提升性能</td> <td>不适合所有场景，可能会引入不必要的锁竞争</td> <td>短时间内频繁加锁和解锁的场景</td></tr> <tr><td>自旋锁</td> <td>避免线程阻塞，减少线程调度开销</td> <td>长时间自旋会占用CPU资源，降低系统性能</td> <td>预期锁竞争时间很短的场景</td></tr> <tr><td>自适应自旋锁</td> <td>动态调整自旋次数，更智能地选择自旋时间</td> <td>需要额外的逻辑判断，自旋时间较长仍会占用CPU资源</td> <td>锁竞争情况变化较大的场景</td></tr> <tr><td>锁消除</td> <td>消除不必要的同步块，减少同步开销</td> <td>依赖于JVM的逃逸分析，不适用于所有情况</td> <td>锁对象不会逃逸出线程的场景</td></tr> <tr><td>偏向锁</td> <td>减少同一线程多次请求锁的开销</td> <td>多线程竞争时撤销偏向锁需要额外开销</td> <td>锁大部分时间被同一线程占用的场景</td></tr> <tr><td>轻量级锁</td> <td>避免重量级锁的开销，提升性能</td> <td>有锁竞争时会膨胀为重量级锁，带来额外开销</td> <td>低竞争环境中的锁操作</td></tr> <tr><td>重量级锁</td> <td>确保线程安全，通过操作系统的Mutex Lock互斥锁实现</td> <td>线程阻塞和上下文切换开销大</td> <td>高竞争环境中需要严格线程同步的场景</td></tr></tbody></table> <h3 id="锁的升级过程"><a href="#锁的升级过程" class="header-anchor">#</a> 锁的升级过程</h3> <p>锁的升级过程涉及了Java中 synchronized 关键字在不同竞争条件下的优化和状态变化。这些状态包括无锁、偏向锁、轻量级锁和重量级锁，根据线程竞争的程度和情况，JVM会自动将锁从一种状态升级到另一种状态，以降低获取锁的成本，提高并发性能。</p> <p>下表是64位JVM下的 Mark Word 各个位储存的数据变化情况(上面已经提到过了)</p> <img src="/blog/images/32-9.png" alt="mixureSecure"> <p>注意： 偏向锁还有一个匿名偏向的状态下面会说到。<br>
匿名偏向状态：即锁对象为偏向锁，但是没有线程偏向于这个锁对象。对应的 Mark Word 标志位后三位是001，前61位都是0。</p> <h3 id="查看对象的内存结构"><a href="#查看对象的内存结构" class="header-anchor">#</a> 查看对象的内存结构</h3> <p>一开始查锁升级相关资料的时候感觉有点绕，还是觉得自己去看下对象头比较靠谱。于是就想JDK有没有提供类似反射的机制获取对象头信息的功能。查了查资料好像没有。 只能通过第三方的jar(JOL)提供的功能。</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.openjdk.jol<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jol-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>jol-core 是一个 Java 库，用于分析对象布局（Layout）和对象内存结构。它的全称是 Java Object Layout，通常简称为 JOL。<br>
主要用处：<br>
对象布局分析，锁状态分析。通过分析对象的结构来进行性能优化。</p> <h3 id="_1、无锁"><a href="#_1、无锁" class="header-anchor">#</a> ①、无锁</h3> <p><strong>需要先补充知识点：</strong><br>
偏向锁是JDK1.6引入的，与此同时，JVM也引入了和偏向锁相关的JVM启动参数。<br>
查看默认的JVM启动参数命令：<code>java -XX:+PrintFlagsFinal -version</code>
有非常多默认的JVM启动参数命令，下面列出来两个和偏向锁相关的配置参数。</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># 这个参数用于启用或禁用偏向锁  </span>
<span class="token comment"># 默认值是 true，表示偏向锁是启用的。</span>
UseBiasedLocking = true  

<span class="token comment"># 这个参数指定在JVM启动后多长时间（以毫秒为单位）启用偏向锁。</span>
<span class="token comment"># 默认值是 4000，表示偏向锁在JVM启动后4秒钟才会启用。</span>
BiasedLockingStartupDelay = 4000
</code></pre></div><p>示例代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>openjdk<span class="token punctuation">.</span>jol<span class="token punctuation">.</span>info<span class="token punctuation">.</span></span><span class="token class-name">ClassLayout</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestA</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TestA</span> testA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 无锁</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;======== 无锁 =========&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>testA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>运行结果(只取Mark Word 部分)：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token constant">OFF</span>  <span class="token constant">SZ</span>   <span class="token constant">TYPE</span> <span class="token constant">DESCRIPTION</span>               <span class="token constant">VALUE</span>
  <span class="token number">0</span>   <span class="token number">8</span>        <span class="token punctuation">(</span>object header<span class="token operator">:</span> mark<span class="token punctuation">)</span>     <span class="token number">0x0000000000000001</span> <span class="token punctuation">(</span>non<span class="token operator">-</span>biasable<span class="token punctuation">;</span> age<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre></div><p>non-biasable表示无锁，0x0000000000000001 转成64位二进制后  ，后三位 001 也对应无锁</p> <p>分析：<br>
JVM默认启用偏向锁，但是JVM启动后4秒钟才会启用，<code>TestA testA = new TestA();</code>是在JVM启用偏向锁之前就创建了，此时<code>testA</code>对象处于无锁状态。</p> <img src="/blog/images/32-10.png" alt="mixureSecure"> <h3 id="_2、偏向锁的匿名偏向状态"><a href="#_2、偏向锁的匿名偏向状态" class="header-anchor">#</a> ②、偏向锁的匿名偏向状态</h3> <p>JVM的参数<code>UseBiasedLocking</code>是个启动开关没啥好说的。<br>
JVM的参数<code>BiasedLockingStartupDelay</code>为什么要延迟启用偏向锁呢？</p> <p>延迟启用偏向锁的主要目的是希望在应用程序启动阶段，避免由于类加载和初始同步造成的短期内大量偏向锁撤销开销。<br>
JVM启动时会延时初始化偏向锁，默认是4秒(可以通过 JVM参数<code>BiasedLockingStartupDelay</code>修改)。初始化后会将所有加载的Klass的prototype header修改为匿名偏向样式。Klass 是 JVM 用来表示 Java 类的一种结构。每个 Klass 对象都包含一个 prototype header，这是一个模板，用于初始化新创建的对象的对象头（Object Header）。当创建一个新对象时，它的对象头会从这个模板中复制初始值。</p> <p>所以当创建一个对象时，会通过Klass的prototype_header来初始化该对象的对象头。<br>
在JVM偏向锁初始化结束后，后续创建的所有对象都为匿名偏向状态（因为JVM偏向锁初始化后会将所有加载的Klass的prototype header修改为匿名偏向样式），在此之前创建的对象则为无锁状态。而对于无锁状态的锁对象，如果有竞争，会直接进入到轻量级锁可以避免偏向锁撤销的开销，从而提高JVM的启动速度。</p> <p>比如可以看下图JVM启动时会加载很多类到内存，类加载的时候就用了synchronized 代码块，此时如果是默认的JVM启动参数，那么4秒内创建的对象刚创建出来是无锁状态，一但遇到竞争就会跳过偏向锁直接进入轻量级锁状态。这也是JVM优化锁性能的一种方式。</p> <img src="/blog/images/32-11.png" alt="mixureSecure"> <p>示例代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>openjdk<span class="token punctuation">.</span>jol<span class="token punctuation">.</span>info<span class="token punctuation">.</span></span><span class="token class-name">ClassLayout</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestA</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// BiasedLockingStartupDelay = 4000</span>
            <span class="token comment">// 这个参数指定在JVM启动后多长时间（以毫秒为单位）启用偏向锁。</span>
            <span class="token comment">// 默认值是 4000，表示偏向锁在JVM启动后4秒钟才会启用。</span>

            <span class="token comment">// 这里等待5秒</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5秒后创建对象</span>
        <span class="token class-name">TestA</span> testA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;======== 偏向锁(匿名偏向状态) =========&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>testA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>运行结果(只取Mark Word 部分)：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>OFF  SZ   TYPE DESCRIPTION               VALUE
  <span class="token number">0</span>   <span class="token number">8</span>        <span class="token punctuation">(</span>object header: mark<span class="token punctuation">)</span>     0x0000000000000005 <span class="token punctuation">(</span>biasable<span class="token punctuation">;</span> age: <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre></div><p>biasable表示可以偏向，0x0000000000000005 转成64位二进制后  ，后三位 101 也对应偏向锁，前61位都是0，表示匿名偏向状态。</p> <h3 id="_3、-匿名偏向状态→偏向锁"><a href="#_3、-匿名偏向状态→偏向锁" class="header-anchor">#</a> ③、  匿名偏向状态→偏向锁</h3> <p><strong>匿名偏向状态的对象在满足以下条件时可以转变为偏向锁状态：</strong> <strong>单线程首次访问：</strong><br>
当一个线程第一次访问该对象的同步代码块时，JVM将该对象的锁标志设置为偏向锁，并将Mark Word中的线程ID字段更新为当前线程的ID。
<strong>无竞争：</strong><br>
如果在一个线程持有偏向锁期间，没有其他线程尝试获取该对象的锁，偏向锁将保持不变。此时，线程可以在不进行同步操作的情况下，快速进入和退出同步块。</p> <p>代码示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>openjdk<span class="token punctuation">.</span>jol<span class="token punctuation">.</span>info<span class="token punctuation">.</span></span><span class="token class-name">ClassLayout</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestA</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// BiasedLockingStartupDelay = 4000</span>
            <span class="token comment">// 这个参数指定在JVM启动后多长时间（以毫秒为单位）启用偏向锁。</span>
            <span class="token comment">// 默认值是 4000，表示偏向锁在JVM启动后4秒钟才会启用。</span>

            <span class="token comment">// 这里等待5秒</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5秒后创建对象</span>
        <span class="token class-name">TestA</span> testA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;======== 偏向锁(匿名偏向状态) =========&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>testA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 遇到同步代码块</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>testA<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;======== 匿名偏向状态 → 偏向锁  =========&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>testA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>运行结果：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> 偏向锁<span class="token punctuation">(</span>匿名偏向状态<span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
OFF  SZ   TYPE DESCRIPTION               VALUE
  <span class="token number">0</span>   <span class="token number">8</span>        <span class="token punctuation">(</span>object header: mark<span class="token punctuation">)</span>     0x0000000000000005 <span class="token punctuation">(</span>biasable<span class="token punctuation">;</span> age: <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> 匿名偏向状态 → 偏向锁  <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
OFF  SZ   TYPE DESCRIPTION               VALUE
  <span class="token number">0</span>   <span class="token number">8</span>        <span class="token punctuation">(</span>object header: mark<span class="token punctuation">)</span>     0x0000000002e92805 <span class="token punctuation">(</span>biased: 0x000000000000ba4a<span class="token punctuation">;</span> epoch: <span class="token number">0</span><span class="token punctuation">;</span> age: <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre></div><p>biased表示偏向锁状态，0x0000000002e92805 转成64位二进制后  ，后三位 101 也对应偏向锁，前61位有非0数据，表示锁偏向的线程id等信息。</p> <img src="/blog/images/32-12.png" alt="mixureSecure"> <h3 id="_3、无锁或偏向锁→轻量级锁"><a href="#_3、无锁或偏向锁→轻量级锁" class="header-anchor">#</a> ③、无锁或偏向锁→轻量级锁</h3> <p><strong>升级为轻量级锁：</strong> <strong>升级条件：</strong></p> <p><strong>偏向锁撤销：</strong>  如果一个对象已经被偏向某个线程，但是另一个线程尝试获取该对象的锁，偏向锁会被撤销，从而升级为轻量级锁。</p> <p><strong>轻量级锁的优势：</strong> 轻量级锁通过CAS操作尝试获取锁，避免了线程阻塞。虽然CAS操作比偏向锁稍有开销，但在高竞争环境下，其效率要高于频繁撤销和重新设置偏向锁的开销。</p> <p><strong>轻量级锁转换和获取过程概述：</strong><br>
线程在执行同步块之前，JVM会先在当前线程的栈桢中创建用于存储锁记录的空间，并将对象头中的Mark Word复制到锁记录中，官方称为Displaced Mark Word。然后线程尝试使用CAS将对象头中的Mark Word替换为指向锁记录的指针。如果成功，当前线程获得锁，如果失败，表示其他线程竞争锁，当前线程便尝试使用自旋来获取锁。</p> <p>代码示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>openjdk<span class="token punctuation">.</span>jol<span class="token punctuation">.</span>info<span class="token punctuation">.</span></span><span class="token class-name">ClassLayout</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestA</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 无锁对象</span>
        <span class="token class-name">TestA</span> testA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;======== 无锁状态 =========&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>testA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>testA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;======== 无锁状态 → 轻量级锁  =========&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>testA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// BiasedLockingStartupDelay = 4000</span>
            <span class="token comment">// 这个参数指定在JVM启动后多长时间（以毫秒为单位）启用偏向锁。</span>
            <span class="token comment">// 默认值是 4000，表示偏向锁在JVM启动后4秒钟才会启用。</span>

            <span class="token comment">// 这里等待5秒</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 匿名偏向锁对象</span>
        <span class="token class-name">TestA</span> testB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;======== 匿名偏向锁状态 =========&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>testB<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>testB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;======== 匿名偏向锁状态 → 偏向锁 且偏向主线程=========&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>testB<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">// 此时另一个线程t1尝试获取 testB 对象的锁  会导致testB的偏向锁撤销 从而升级为轻量级锁</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>testB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;======== 偏向锁 → 轻量级锁 =========&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>testB<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行结果：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> 无锁状态 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token constant">OFF</span>  <span class="token constant">SZ</span>   <span class="token constant">TYPE</span> <span class="token constant">DESCRIPTION</span>               <span class="token constant">VALUE</span>
<span class="token number">0</span>   <span class="token number">8</span>        <span class="token punctuation">(</span>object header<span class="token operator">:</span> mark<span class="token punctuation">)</span>     <span class="token number">0x0000000000000001</span> <span class="token punctuation">(</span>non<span class="token operator">-</span>biasable<span class="token punctuation">;</span> age<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> 无锁状态 → 轻量级锁  <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token class-name">TestA</span> object internals<span class="token operator">:</span>
<span class="token constant">OFF</span>  <span class="token constant">SZ</span>   <span class="token constant">TYPE</span> <span class="token constant">DESCRIPTION</span>               <span class="token constant">VALUE</span>
<span class="token number">0</span>   <span class="token number">8</span>        <span class="token punctuation">(</span>object header<span class="token operator">:</span> mark<span class="token punctuation">)</span>     <span class="token number">0x00000000033ff2d0</span> <span class="token punctuation">(</span>thin lock<span class="token operator">:</span> <span class="token number">0x00000000033ff2d0</span><span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> 匿名偏向锁状态 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token class-name">TestA</span> object internals<span class="token operator">:</span>
<span class="token constant">OFF</span>  <span class="token constant">SZ</span>   <span class="token constant">TYPE</span> <span class="token constant">DESCRIPTION</span>               <span class="token constant">VALUE</span>
<span class="token number">0</span>   <span class="token number">8</span>        <span class="token punctuation">(</span>object header<span class="token operator">:</span> mark<span class="token punctuation">)</span>     <span class="token number">0x0000000000000005</span> <span class="token punctuation">(</span>biasable<span class="token punctuation">;</span> age<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span>  
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> 匿名偏向锁状态 → 偏向锁 且偏向主线程<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token class-name">TestA</span> object internals<span class="token operator">:</span>
<span class="token constant">OFF</span>  <span class="token constant">SZ</span>   <span class="token constant">TYPE</span> <span class="token constant">DESCRIPTION</span>               <span class="token constant">VALUE</span>
<span class="token number">0</span>   <span class="token number">8</span>        <span class="token punctuation">(</span>object header<span class="token operator">:</span> mark<span class="token punctuation">)</span>     <span class="token number">0x00000000035a2805</span> <span class="token punctuation">(</span>biased<span class="token operator">:</span> <span class="token number">0x000000000000d68a</span><span class="token punctuation">;</span> epoch<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span> age<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> 偏向锁 → 轻量级锁 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
<span class="token class-name">TestA</span> object internals<span class="token operator">:</span>
<span class="token constant">OFF</span>  <span class="token constant">SZ</span>   <span class="token constant">TYPE</span> <span class="token constant">DESCRIPTION</span>               <span class="token constant">VALUE</span>
<span class="token number">0</span>   <span class="token number">8</span>        <span class="token punctuation">(</span>object header<span class="token operator">:</span> mark<span class="token punctuation">)</span>     <span class="token number">0x00000000206af270</span> <span class="token punctuation">(</span>thin lock<span class="token operator">:</span> <span class="token number">0x00000000206af270</span><span class="token punctuation">)</span>  
</code></pre></div><p>分析：<br>
无锁状态 → 轻量级锁 ：这个是因为JVM偏向锁功能还没启动完成。所以线程遇到同步代码块会直接由 无锁状态 → 轻量级锁。<br>
偏向锁 → 轻量级锁： 因为<code>testB</code>对象已经被偏向主线程，但是另一个线程<code>t1</code>尝试获取该对象的锁，偏向锁会被撤销，从而升级为轻量级锁。</p> <img src="/blog/images/32-13.png" alt="mixureSecure"> <h3 id="_4、轻量级锁→重量级锁"><a href="#_4、轻量级锁→重量级锁" class="header-anchor">#</a> ④、轻量级锁→重量级锁</h3> <p><strong>轻量级锁升级为重量级锁的条件：</strong> <strong>自旋失败：</strong> 当一个线程尝试获取一个已经被其他线程持有的轻量级锁时，JVM会让这个线程自旋一段时间，尝试获取锁。如果自旋次数超过一定的阈值（默认是10次，对应JVM参数<code>PreInflateSpin</code>），自旋会失败，导致 轻量级锁→重量级锁。</p> <p><strong>竞争激烈：</strong> 如果多个线程频繁地争抢同一个锁，并且这些线程自旋失败的情况持续发生，那么 JVM 会将该锁升级为重量级锁，以避免自旋浪费大量 CPU 资源。</p> <p><strong>线程数目多：</strong> 当等待获取锁的线程数目达到一定程度（通常是 2 个以上），轻量级锁会被升级为重量级锁。重量级锁依赖操作系统的互斥机制，会导致线程阻塞和上下文切换。</p> <p>JVM参数：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment">## 轻量级锁升级为重量级锁之前自旋等待的次数</span>
<span class="token comment">## 这个参数决定了线程在放弃轻量级锁并升级为重量级锁之前，自旋尝试获取锁的最大次数</span>
<span class="token key attr-name">PreInflateSpin</span> <span class="token punctuation">=</span> <span class="token value attr-value">10</span>

<span class="token comment">## 线程在进入阻塞状态之前自旋等待的次数</span>
<span class="token comment">## 这个参数决定了线程在放弃轻量级锁并进入阻塞状态之前，自旋尝试获取锁的最大次数</span>
<span class="token key attr-name">PreBlockSpin</span> <span class="token punctuation">=</span> <span class="token value attr-value">10</span>
</code></pre></div><p>在windows版本的<code>java version &quot;1.8.0_202&quot;</code> 这个版本中 我并没有找到<code>PreBlockSpin</code> 这个参数，也许这个版本已经移除了<code>PreBlockSpin</code>这个参数。（猜测）</p> <img src="/blog/images/32-14.png" alt="mixureSecure"> <p>当 JVM 决定将轻量级锁膨胀为重量级锁时，会创建一个重量级锁（monitor 对象）。轻量级锁的持有线程将对象头的 Mark Word 中的指针更新为指向 monitor 对象。Monitor 对象包含了锁的状态、持有锁的线程、等待队列等信息。<br>
竞争锁失败的线程将进入 monitor 对象的等待队列，操作系统会阻塞这些线程。当持有锁的线程释放锁时，它会通知操作系统唤醒等待队列中的一个或多个线程，尝试重新获取锁。重量级锁的获取和释放涉及操作系统的系统调用，会导致CPU进行状态切换（用户态→内核态→用户态）、还有可能导致线程阻塞和唤醒(线程上下文切换)，因此性能较低(这个在上面的知识铺垫里有详细说到)。</p> <p>代码示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>openjdk<span class="token punctuation">.</span>jol<span class="token punctuation">.</span>info<span class="token punctuation">.</span></span><span class="token class-name">ClassLayout</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestA</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 无锁对象</span>
        <span class="token class-name">TestA</span> testA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;======== 无锁状态 =========&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>testA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>testA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;======== 无锁状态 → 轻量级锁  =========&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>testA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>testA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;======== 轻量级锁 → 重量级锁  t1竞争=========&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>testA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>testA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;======== 轻量级锁 → 重量级锁  t2竞争=========&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">ClassLayout</span><span class="token punctuation">.</span><span class="token function">parseInstance</span><span class="token punctuation">(</span>testA<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPrintable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行结果：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> 无锁状态 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
TestA object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
<span class="token number">0</span>   <span class="token number">8</span>        <span class="token punctuation">(</span>object header: mark<span class="token punctuation">)</span>     0x0000000000000001 <span class="token punctuation">(</span>non-biasable<span class="token punctuation">;</span> age: <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> 无锁状态 → 轻量级锁  <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
TestA object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
<span class="token number">0</span>   <span class="token number">8</span>        <span class="token punctuation">(</span>object header: mark<span class="token punctuation">)</span>     0x00000000032bf1a8 <span class="token punctuation">(</span>thin lock: 0x00000000032bf1a8<span class="token punctuation">)</span>

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> 轻量级锁 → 重量级锁  t1竞争<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
TestA object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
<span class="token number">0</span>   <span class="token number">8</span>        <span class="token punctuation">(</span>object header: mark<span class="token punctuation">)</span>     0x00000000205ef070 <span class="token punctuation">(</span>thin lock: 0x00000000205ef070<span class="token punctuation">)</span>

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> 轻量级锁 → 重量级锁  t2竞争<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
TestA object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
<span class="token number">0</span>   <span class="token number">8</span>        <span class="token punctuation">(</span>object header: mark<span class="token punctuation">)</span>     0x000000001ceef5da <span class="token punctuation">(</span>fat lock: 0x000000001ceef5da<span class="token punctuation">)</span>
</code></pre></div><p>可以看到t2竞争的时候锁升级到了重量级。<br>
有时候执行上面代码，t1和t2打印的都有可能是重量级。</p> <h3 id="锁升级图示"><a href="#锁升级图示" class="header-anchor">#</a> 锁升级图示：</h3> <p>这个就不自己整理了(又偷懒了~)
<a href="https://tech.youzan.com/javasuo-yu-xian-cheng-de-na-xie-shi/" target="_blank" rel="noopener noreferrer">图片来源https://tech.youzan.com/javasuo-yu-xian-cheng-de-na-xie-shi/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><br>
图片来源的这篇博客里对于锁的升级过程，偏向JVM实现层面。如果想深入了解的话，建议去仔细看看这篇博客。</p> <img src="/blog/images/32-15.png" alt="mixureSecure"> <p>注意：<br>
偏向锁在JDK 15中被标记为弃用（deprecated），并计划在未来版本中删除。<br>
在JDK 17中，偏向锁已经被移除。</p> <p>JDK为什么要移除偏向锁？<br>
大致有下面几个原因：</p> <ul><li>复杂性: 偏向锁增加了HotSpot JVM代码的复杂性。</li> <li>收益减少: 在现代硬件和应用程序中，偏向锁带来的性能提升变得不明显。</li> <li>维护成本: 随着JVM的演进，维护偏向锁功能变得越来越困难。<br>
就是吃力不讨好了，干脆就不要了。</li></ul> <h2 id="_7、总结synchronized保证原子、可见、有序性原理"><a href="#_7、总结synchronized保证原子、可见、有序性原理" class="header-anchor">#</a> 7、总结synchronized保证原子、可见、有序性原理</h2> <h3 id="_1、java代码层面"><a href="#_1、java代码层面" class="header-anchor">#</a> ①、Java代码层面</h3> <p>在 Java 中，使用 synchronized 关键字可以确保同一时刻只有一个线程能执行被 <code>synchronized</code> 修饰的代码块或方法，从而保证临界区代码的原子性和线程安全。同时JMM的监视器锁规则：对同一个监视器的解锁，happens-before于对该监视器的加锁。也保证了可见性。</p> <h3 id="_2、jvm-层面"><a href="#_2、jvm-层面" class="header-anchor">#</a> ②、JVM 层面</h3> <p>锁的实现
synchronized 关键字在编译后的字节码中，会转换成 monitorenter 和 monitorexit 指令。monitorenter 在同步代码块的开始位置，monitorexit 在同步代码块的结束位置和异常处。</p> <p>Monitor 和对象头
每个对象在 JVM 中都有一个对象头，其中包含Mark Word区域，Mark Word包含锁标志位和其他信息。monitorenter 和 monitorexit 指令会检查并操作对象头中Mark Word的锁信息。如果锁竞争激烈，JVM 会进行锁升级，并在对象头中设置指向 monitor 对象的指针。Monitor 对象包含锁的状态、持有锁的线程以及等待队列等信息。</p> <p>注意点：<br>
Monitor 监视器并不是在对象创建时就存在的，而是在锁竞争激烈的情况下（如轻量级锁失败并升级为重量级锁时）才会创建。初始状态下，对象头的 Mark Word 仅包含基本的锁信息，而不包含具体的 Monitor 对象。只有在需要重量级锁时，才会分配并使用 Monitor 对象来管理锁的状态和线程的阻塞与唤醒。</p> <p>锁的类型<br>
偏向锁：无竞争时，线程偏向于自己持有的锁。
轻量级锁：有少量竞争时，采用 CAS 操作避免线程阻塞。
重量级锁：高竞争时，使用操作系统的互斥锁机制，涉及线程阻塞和唤醒，性能较低。</p> <h3 id="_3、操作系统层面"><a href="#_3、操作系统层面" class="header-anchor">#</a> ③、操作系统层面</h3> <p>互斥锁（Mutex Lock）
重量级锁依赖于操作系统的互斥锁机制。当轻量级锁竞争失败时，JVM 会将其升级为重量级锁，涉及系统调用(可能会有线程的上下文切换和CPU内核态状态转换)。</p> <h3 id="_4、处理器层面"><a href="#_4、处理器层面" class="header-anchor">#</a> ④、处理器层面</h3> <p>缓存一致性协议和<code>lock</code>前缀指令
多处理器系统中，为了保证可见性和有序性，处理器采用缓存一致性协议（如 MESI 协议）来维护各个处理器缓存的同步。
JIT编译器使用<code>lock</code>前缀指令完成处理器级别的原子操作，禁止重排序操作，以此保证共享变量的原子性和有序性，并通过缓存一致性协议保证共享变量的可见性。</p> <h2 id="补充-为什么有synchronized了jdk还要设计lock"><a href="#补充-为什么有synchronized了jdk还要设计lock" class="header-anchor">#</a> 补充：为什么有synchronized了JDK还要设计Lock</h2> <p>除了 synchronized 关键字之外，JDK 还引入了 java.util.concurrent.locks 包中的显式锁（如 ReentrantLock）。两者虽然都用于线程同步，但各有优缺点和适用场景。</p> <p>原因其实很简单，有些业务场景synchronized不支持。<br>
比如：<br>
尝试获取锁，2秒获取不到就放弃。<br>
让等待的线程响应中断。<br>
设置锁的公平性。<br>
获取不到锁立马返回false(非阻塞式)。<br>
有多个等待或者唤醒的条件。<br>
无法自定义synchronized的行为。</p> <p>上面说的synchronized不支持的 Lock  都支持，但是synchronized并非一无是处，synchronized不用显式释放锁，api使用简单，不需要创建特殊的锁对象。</p> <p>所以实际业务中，进行简单的同步使用synchronized是比较推荐的。</p> <p>Lock 的详解就放到后面吧。</p> <h3 id="写在最后"><a href="#写在最后" class="header-anchor">#</a> 写在最后</h3> <p>这篇文章写着写着，又是一周过去了。。。发现并发这块内容真的，不整理还好，一整理就真的~   一周能整理出一篇就不错了，自闭中~<br>
希望这篇文章对你理解synchronized有所帮助。</p> <p>我写的这篇内容也只是东拼西凑罢了，稍微加了点自己的理解，补充了一些知识点，让知识点更自然的衔接起来。<br>
因为写这些文章的目的就是构建自己Java知识体系，所以排版就顺着自己的思维走会显得很啰嗦。</p> <p>最后感谢下面这些资料：<br>
https://tech.youzan.com/javasuo-yu-xian-cheng-de-na-xie-shi<br>
https://www.cnblogs.com/star95/p/17542850.html<br>
https://javaguide.cn<br>
https://pdai.tech<br>
https://ifeve.com<br>
《Java并发编程的艺术》<br>
《Java并发实现原理：JDK源码剖析》<br>
《Java并发编程之美》<br>
《图解Java多线程设计模式》</p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/blog/java-concurrent/三、volatile关键字详解.html" class="prev">
          三、volatile关键字详解
        </a></span> <span class="next"><a href="/blog/java-concurrent/五、AQS详解.html">
          五、AQS详解
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_1、synchronized关键字简介" class="sidebar-link reco-side-_1、synchronized关键字简介" data-v-b57cc07c>1、synchronized关键字简介</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_2、synchronized作用和使用场景" class="sidebar-link reco-side-_2、synchronized作用和使用场景" data-v-b57cc07c>2、synchronized作用和使用场景</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#作用" class="sidebar-link reco-side-作用" data-v-b57cc07c>作用</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#使用场景" class="sidebar-link reco-side-使用场景" data-v-b57cc07c>使用场景</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_1、用在代码块上-类级别同步" class="sidebar-link reco-side-_1、用在代码块上-类级别同步" data-v-b57cc07c>①、用在代码块上(类级别同步)</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_2、用在代码块上-对象级别同步" class="sidebar-link reco-side-_2、用在代码块上-对象级别同步" data-v-b57cc07c>②、用在代码块上(对象级别同步)</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_3、用在普通方法上-对象级别同步" class="sidebar-link reco-side-_3、用在普通方法上-对象级别同步" data-v-b57cc07c>③、用在普通方法上(对象级别同步)</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_4、用在静态方法上-类级别同步" class="sidebar-link reco-side-_4、用在静态方法上-类级别同步" data-v-b57cc07c>④、用在静态方法上(类级别同步)</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#总结" class="sidebar-link reco-side-总结" data-v-b57cc07c>总结：</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_3、synchronized底层原理-jvm层面" class="sidebar-link reco-side-_3、synchronized底层原理-jvm层面" data-v-b57cc07c>3、synchronized底层原理（JVM层面）</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#idea配置javap工具查看字节码" class="sidebar-link reco-side-idea配置javap工具查看字节码" data-v-b57cc07c>IDEA配置javap工具查看字节码</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#查看同步代码块的字节码" class="sidebar-link reco-side-查看同步代码块的字节码" data-v-b57cc07c>查看同步代码块的字节码</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#分析同步代码块字节码" class="sidebar-link reco-side-分析同步代码块字节码" data-v-b57cc07c>分析同步代码块字节码</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#查看同步方法的字节码" class="sidebar-link reco-side-查看同步方法的字节码" data-v-b57cc07c>查看同步方法的字节码</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#分析同步方法字节码" class="sidebar-link reco-side-分析同步方法字节码" data-v-b57cc07c>分析同步方法字节码</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#补充知识点-对象头" class="sidebar-link reco-side-补充知识点-对象头" data-v-b57cc07c>补充知识点：对象头</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#monitor-监视器" class="sidebar-link reco-side-monitor-监视器" data-v-b57cc07c>Monitor（监视器）</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#监视器锁" class="sidebar-link reco-side-监视器锁" data-v-b57cc07c>监视器锁</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#synchronized到底锁的是哪个对象" class="sidebar-link reco-side-synchronized到底锁的是哪个对象" data-v-b57cc07c>synchronized到底锁的是哪个对象？</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#让秀逗告诉你锁的本质-通俗点的例子" class="sidebar-link reco-side-让秀逗告诉你锁的本质-通俗点的例子" data-v-b57cc07c>让秀逗告诉你锁的本质(通俗点的例子)</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#java中为什么要设计成全员皆锁" class="sidebar-link reco-side-java中为什么要设计成全员皆锁" data-v-b57cc07c>Java中为什么要设计成全员皆锁</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_4、synchronized和wait、notify" class="sidebar-link reco-side-_4、synchronized和wait、notify" data-v-b57cc07c>4、synchronized和wait、notify</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#首先需要先明确一个问题" class="sidebar-link reco-side-首先需要先明确一个问题" data-v-b57cc07c>首先需要先明确一个问题：</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#为什么wait-和notify-方法必须和synchronized一起使用" class="sidebar-link reco-side-为什么wait-和notify-方法必须和synchronized一起使用" data-v-b57cc07c>为什么wait()和notify()方法必须和synchronized一起使用？</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#等待监视器锁的线程放在哪儿了-引出生产者-消费者模式" class="sidebar-link reco-side-等待监视器锁的线程放在哪儿了-引出生产者-消费者模式" data-v-b57cc07c>等待监视器锁的线程放在哪儿了？引出生产者-消费者模式</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_5、synchronized监视器锁可重入原理" class="sidebar-link reco-side-_5、synchronized监视器锁可重入原理" data-v-b57cc07c>5、synchronized监视器锁可重入原理</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#动画总结synchronized-监视器锁原理" class="sidebar-link reco-side-动画总结synchronized-监视器锁原理" data-v-b57cc07c>动画总结synchronized 监视器锁原理：</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_6、synchronized锁升级过程" class="sidebar-link reco-side-_6、synchronized锁升级过程" data-v-b57cc07c>6、synchronized锁升级过程</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#补充知识点" class="sidebar-link reco-side-补充知识点" data-v-b57cc07c>补充知识点：</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#mutex-lock-互斥锁" class="sidebar-link reco-side-mutex-lock-互斥锁" data-v-b57cc07c>Mutex Lock（互斥锁）：</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#内核态和用户态" class="sidebar-link reco-side-内核态和用户态" data-v-b57cc07c>内核态和用户态：</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#内核态和用户态的切换" class="sidebar-link reco-side-内核态和用户态的切换" data-v-b57cc07c>内核态和用户态的切换：</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#jdk6之前synchronized为什么性能不好" class="sidebar-link reco-side-jdk6之前synchronized为什么性能不好" data-v-b57cc07c>JDK6之前synchronized为什么性能不好</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#真正的主角登场-jdk1-6对锁的升级" class="sidebar-link reco-side-真正的主角登场-jdk1-6对锁的升级" data-v-b57cc07c>真正的主角登场(JDK1.6对锁的升级)</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#对锁的优化方式介绍" class="sidebar-link reco-side-对锁的优化方式介绍" data-v-b57cc07c>对锁的优化方式介绍</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#锁的升级过程" class="sidebar-link reco-side-锁的升级过程" data-v-b57cc07c>锁的升级过程</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#查看对象的内存结构" class="sidebar-link reco-side-查看对象的内存结构" data-v-b57cc07c>查看对象的内存结构</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_1、无锁" class="sidebar-link reco-side-_1、无锁" data-v-b57cc07c>①、无锁</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_2、偏向锁的匿名偏向状态" class="sidebar-link reco-side-_2、偏向锁的匿名偏向状态" data-v-b57cc07c>②、偏向锁的匿名偏向状态</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_3、-匿名偏向状态→偏向锁" class="sidebar-link reco-side-_3、-匿名偏向状态→偏向锁" data-v-b57cc07c>③、  匿名偏向状态→偏向锁</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_3、无锁或偏向锁→轻量级锁" class="sidebar-link reco-side-_3、无锁或偏向锁→轻量级锁" data-v-b57cc07c>③、无锁或偏向锁→轻量级锁</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_4、轻量级锁→重量级锁" class="sidebar-link reco-side-_4、轻量级锁→重量级锁" data-v-b57cc07c>④、轻量级锁→重量级锁</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#锁升级图示" class="sidebar-link reco-side-锁升级图示" data-v-b57cc07c>锁升级图示：</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_7、总结synchronized保证原子、可见、有序性原理" class="sidebar-link reco-side-_7、总结synchronized保证原子、可见、有序性原理" data-v-b57cc07c>7、总结synchronized保证原子、可见、有序性原理</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_1、java代码层面" class="sidebar-link reco-side-_1、java代码层面" data-v-b57cc07c>①、Java代码层面</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_2、jvm-层面" class="sidebar-link reco-side-_2、jvm-层面" data-v-b57cc07c>②、JVM 层面</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_3、操作系统层面" class="sidebar-link reco-side-_3、操作系统层面" data-v-b57cc07c>③、操作系统层面</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#_4、处理器层面" class="sidebar-link reco-side-_4、处理器层面" data-v-b57cc07c>④、处理器层面</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#补充-为什么有synchronized了jdk还要设计lock" class="sidebar-link reco-side-补充-为什么有synchronized了jdk还要设计lock" data-v-b57cc07c>补充：为什么有synchronized了JDK还要设计Lock</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%9B%9B%E3%80%81synchronized%E5%85%B3%E9%94%AE%E5%AD%97%E8%AF%A6%E8%A7%A3.html#写在最后" class="sidebar-link reco-side-写在最后" data-v-b57cc07c>写在最后</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/blog/assets/js/app.ee3639f3.js" defer></script><script src="/blog/assets/js/7.1252e5d3.js" defer></script><script src="/blog/assets/js/2.11926632.js" defer></script><script src="/blog/assets/js/1.9554eb00.js" defer></script><script src="/blog/assets/js/64.222454f0.js" defer></script>
  </body>
</html>
