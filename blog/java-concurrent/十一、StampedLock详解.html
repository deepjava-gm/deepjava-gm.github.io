<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>StampedLock详解 | GM的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="stylesheet" href="/blog/custom.css">
    <script src="/blog/custom.js"></script>
    <meta name="description" content="博观约取、厚积薄发。">
    
    <link rel="preload" href="/blog/assets/css/0.styles.0612dbff.css" as="style"><link rel="preload" href="/blog/assets/js/app.aa36b75b.js" as="script"><link rel="preload" href="/blog/assets/js/7.272de20f.js" as="script"><link rel="preload" href="/blog/assets/js/2.cc89bbf4.js" as="script"><link rel="preload" href="/blog/assets/js/1.fb256d2a.js" as="script"><link rel="preload" href="/blog/assets/js/62.67670094.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.6c064207.js"><link rel="prefetch" href="/blog/assets/js/11.3e7d7892.js"><link rel="prefetch" href="/blog/assets/js/14.2a1ed16e.js"><link rel="prefetch" href="/blog/assets/js/15.c436ecdb.js"><link rel="prefetch" href="/blog/assets/js/16.5627e9c8.js"><link rel="prefetch" href="/blog/assets/js/17.cf799d13.js"><link rel="prefetch" href="/blog/assets/js/18.21f1f4b3.js"><link rel="prefetch" href="/blog/assets/js/19.c3aec7ee.js"><link rel="prefetch" href="/blog/assets/js/20.73f0a331.js"><link rel="prefetch" href="/blog/assets/js/21.108c76a9.js"><link rel="prefetch" href="/blog/assets/js/22.f6b8bd65.js"><link rel="prefetch" href="/blog/assets/js/23.331063ae.js"><link rel="prefetch" href="/blog/assets/js/24.67f51b5a.js"><link rel="prefetch" href="/blog/assets/js/25.55e00822.js"><link rel="prefetch" href="/blog/assets/js/26.692e69bd.js"><link rel="prefetch" href="/blog/assets/js/27.20ab0ec1.js"><link rel="prefetch" href="/blog/assets/js/28.99545882.js"><link rel="prefetch" href="/blog/assets/js/29.ca1f8c5d.js"><link rel="prefetch" href="/blog/assets/js/3.71f4b310.js"><link rel="prefetch" href="/blog/assets/js/30.2962fbba.js"><link rel="prefetch" href="/blog/assets/js/31.2fc639e9.js"><link rel="prefetch" href="/blog/assets/js/32.97324ada.js"><link rel="prefetch" href="/blog/assets/js/33.23619402.js"><link rel="prefetch" href="/blog/assets/js/34.d9e34b8a.js"><link rel="prefetch" href="/blog/assets/js/35.c4f7378c.js"><link rel="prefetch" href="/blog/assets/js/36.71d98d02.js"><link rel="prefetch" href="/blog/assets/js/37.d91b968d.js"><link rel="prefetch" href="/blog/assets/js/38.ed46a184.js"><link rel="prefetch" href="/blog/assets/js/39.c75715a7.js"><link rel="prefetch" href="/blog/assets/js/4.7cc749e8.js"><link rel="prefetch" href="/blog/assets/js/40.364bac1d.js"><link rel="prefetch" href="/blog/assets/js/41.22ce59c2.js"><link rel="prefetch" href="/blog/assets/js/42.ce64514c.js"><link rel="prefetch" href="/blog/assets/js/43.06b0c452.js"><link rel="prefetch" href="/blog/assets/js/44.1e64cd60.js"><link rel="prefetch" href="/blog/assets/js/45.75e011f9.js"><link rel="prefetch" href="/blog/assets/js/46.996867f3.js"><link rel="prefetch" href="/blog/assets/js/47.80c7ee73.js"><link rel="prefetch" href="/blog/assets/js/48.d4179aba.js"><link rel="prefetch" href="/blog/assets/js/49.e7c29b24.js"><link rel="prefetch" href="/blog/assets/js/5.42dc1081.js"><link rel="prefetch" href="/blog/assets/js/50.dcee16ed.js"><link rel="prefetch" href="/blog/assets/js/51.a987285d.js"><link rel="prefetch" href="/blog/assets/js/52.09affb71.js"><link rel="prefetch" href="/blog/assets/js/53.6488d9e4.js"><link rel="prefetch" href="/blog/assets/js/54.c642f707.js"><link rel="prefetch" href="/blog/assets/js/55.da85728d.js"><link rel="prefetch" href="/blog/assets/js/56.913d645b.js"><link rel="prefetch" href="/blog/assets/js/57.58b32b16.js"><link rel="prefetch" href="/blog/assets/js/58.883d3b76.js"><link rel="prefetch" href="/blog/assets/js/59.31b22d53.js"><link rel="prefetch" href="/blog/assets/js/6.b5ec739c.js"><link rel="prefetch" href="/blog/assets/js/60.32c8305c.js"><link rel="prefetch" href="/blog/assets/js/61.a33bb84d.js"><link rel="prefetch" href="/blog/assets/js/63.2b40b104.js"><link rel="prefetch" href="/blog/assets/js/64.c623834b.js"><link rel="prefetch" href="/blog/assets/js/65.9bc16f13.js"><link rel="prefetch" href="/blog/assets/js/66.166ea331.js"><link rel="prefetch" href="/blog/assets/js/67.907e1ee4.js"><link rel="prefetch" href="/blog/assets/js/68.20e23ac0.js"><link rel="prefetch" href="/blog/assets/js/69.2b0c3a93.js"><link rel="prefetch" href="/blog/assets/js/70.95dbaaee.js"><link rel="prefetch" href="/blog/assets/js/71.19b33212.js"><link rel="prefetch" href="/blog/assets/js/72.a7a0893f.js"><link rel="prefetch" href="/blog/assets/js/73.2dbe546c.js"><link rel="prefetch" href="/blog/assets/js/74.e9a61875.js"><link rel="prefetch" href="/blog/assets/js/75.842d1a59.js"><link rel="prefetch" href="/blog/assets/js/76.a39915a0.js"><link rel="prefetch" href="/blog/assets/js/77.18dfad1c.js"><link rel="prefetch" href="/blog/assets/js/78.3a63a875.js"><link rel="prefetch" href="/blog/assets/js/79.048569ea.js"><link rel="prefetch" href="/blog/assets/js/8.92831dcf.js"><link rel="prefetch" href="/blog/assets/js/80.faf81bfe.js"><link rel="prefetch" href="/blog/assets/js/81.827bb5c0.js"><link rel="prefetch" href="/blog/assets/js/82.c59d3f92.js"><link rel="prefetch" href="/blog/assets/js/83.8254bd19.js"><link rel="prefetch" href="/blog/assets/js/9.bfffe90e.js"><link rel="prefetch" href="/blog/assets/js/vendors~docsearch.6e140397.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.0612dbff.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>GM的博客</h3> <p class="description" data-v-59e6cb88>博观约取、厚积薄发。</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/head.jpg" alt="GM的博客" class="logo"> <span class="site-name">GM的博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://deepjava-gm.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      GM的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/deepjava-gm" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/qq_37883866" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>45</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="https://deepjava-gm.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  首页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      GM的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/deepjava-gm" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/qq_37883866" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/blog/" class="sidebar-heading clickable router-link-active"><span>构建自己的Java知识体系</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/" aria-current="page" class="sidebar-link">引言</a></li><li><a href="/blog/contact.html" class="sidebar-link">反馈</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/javabase/一、Java基础知识" class="sidebar-heading clickable"><span>Java基础</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/java-collection/一、Java集合概述" class="sidebar-heading clickable"><span>Java集合</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/java-concurrent/一、Java并发编程基础知识点" class="sidebar-heading clickable open"><span>Java并发编程</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/java-concurrent/一、Java并发编程基础知识点.html" class="sidebar-link">一、Java并发编程基础知识点</a></li><li><a href="/blog/java-concurrent/二、JMM(Java内存模型)详解.html" class="sidebar-link">二、JMM(Java内存模型)详解</a></li><li><a href="/blog/java-concurrent/三、volatile关键字详解.html" class="sidebar-link">三、volatile关键字详解</a></li><li><a href="/blog/java-concurrent/四、synchronized关键字详解.html" class="sidebar-link">四、synchronized关键字详解</a></li><li><a href="/blog/java-concurrent/五、AQS详解.html" class="sidebar-link">五、AQS详解</a></li><li><a href="/blog/java-concurrent/六、LockSupport详解.html" class="sidebar-link">六、LockSupport详解</a></li><li><a href="/blog/java-concurrent/七、JUC包下的并发工具类.html" class="sidebar-link">七、JUC包下的并发工具类</a></li><li><a href="/blog/java-concurrent/八、ThreadLocal详解.html" class="sidebar-link">八、ThreadLocal详解</a></li><li><a href="/blog/java-concurrent/九、Java锁详解.html" class="sidebar-link">九、Java锁详解</a></li><li><a href="/blog/java-concurrent/十、ReentrantReadWriteLock详解.html" class="sidebar-link">十、ReentrantReadWriteLock详解</a></li><li><a href="/blog/java-concurrent/十一、StampedLock详解.html" class="active sidebar-link">十一、StampedLock详解</a></li><li><a href="/blog/java-concurrent/十二、Java线程池.html" class="sidebar-link">十二、Java线程池</a></li><li><a href="/blog/java-concurrent/十三、FutureTask详解.html" class="sidebar-link">十三、FutureTask详解</a></li><li><a href="/blog/java-concurrent/十四、CompletableFuture详解.html" class="sidebar-link">十四、CompletableFuture详解</a></li><li><a href="/blog/java-concurrent/十五、Java CAS、Unsafe类、原子类详解.html" class="sidebar-link">十五、Java CAS、Unsafe类、原子类详解</a></li><li><a href="/blog/java-concurrent/十六、final关键字详解.html" class="sidebar-link">十六、final关键字详解</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88></h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">StampedLock详解</h1> <div data-v-8a445198><!----> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 id="stampedlock详解"><a href="#stampedlock详解" class="header-anchor">#</a> StampedLock详解</h1> <h2 id="_1、stampedlock简介"><a href="#_1、stampedlock简介" class="header-anchor">#</a> 1、StampedLock简介</h2> <p><code>StampedLock</code> 是JUC并发包里面 JDK8 版本新增的一个锁，是读写锁的一种具体实现，和<code>ReentrantReadWriteLock</code> 不同的是其不提供可重入性，不基于某个类似Lock或者ReadWriteLock接口实现,而是基于CLH锁思想实现这点这AQS有些类似，并且StampedLock不支持条件变量 <code>Condition</code>  。 关于<code>ReentrantReadWriteLock</code> 可以参考上篇文章 <a href="https://deepjava.blog.csdn.net/article/details/140664330" target="_blank" rel="noopener noreferrer"><code>ReentrantReadWriteLock</code> 详解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>那么JDK既然实现了这个锁，就说明这个锁一定有优势，那就是性能优势，下面会具体分析。</p> <h3 id="stampedlock-三个主要的锁模式"><a href="#stampedlock-三个主要的锁模式" class="header-anchor">#</a> StampedLock 三个主要的锁模式</h3> <p><strong>写锁模式（writeLock()）：</strong>  用于排他性地写操作。在写锁模式下，其他线程既无法获取读锁，也无法获取写锁。</p> <p><strong>乐观读锁模式（tryOptimisticRead()）：</strong>  允许线程进行读操作而不获取读锁，这种模式假设在读操作过程中数据不会被其他线程修改。如果发现数据被修改，可以重新获取悲观读锁以保证数据一致性。</p> <p><strong>悲观读锁模式（readLock()）：</strong>  类似于 ReadWriteLock 的读锁，允许多个线程同时获取读锁，但无法与写锁共存。</p> <h3 id="戳记"><a href="#戳记" class="header-anchor">#</a> 戳记</h3> <p><strong>戳记（stamp）</strong> 是 StampedLock 的关键，表示当前锁的状态。获取锁时返回的戳记值在后续的锁操作中用于验证锁的有效性，确保在锁的释放或转换操作中锁的状态是正确的。使用戳记有助于减少锁的争用和开销， StampedLock 通过提供乐观读锁在多线程多读的情况下提供了更好的性能，这是因为获取乐观读锁时不需要进行 CAS 操作设置锁的状态，而只是简单地测试状态。</p> <h3 id="获取锁和释放锁的方法"><a href="#获取锁和释放锁的方法" class="header-anchor">#</a> 获取锁和释放锁的方法</h3> <p><strong>获取锁：</strong><br>
tryOptimisticRead(): 获取乐观读锁，返回戳记。
readLock(): 获取悲观读锁，返回戳记。<br>
writeLock(): 获取写锁，返回戳记。</p> <p><strong>释放锁：</strong><br>
unlockRead(stamp): 释放读锁（悲观读锁或乐观读锁）。<br>
unlockWrite(stamp): 释放写锁。</p> <h3 id="转换锁"><a href="#转换锁" class="header-anchor">#</a> 转换锁</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 尝试将当前持有的锁转换为写锁</span>
<span class="token keyword">long</span> <span class="token function">tryConvertToWriteLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> stamp<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// 尝试将当前持有的写锁转换为读锁</span>
<span class="token keyword">long</span> <span class="token function">tryConvertToReadLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> stamp<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// 尝试将当前持有的悲观读锁转换为乐观读锁</span>
<span class="token keyword">long</span> <span class="token function">tryConvertToOptimisticRead</span><span class="token punctuation">(</span><span class="token keyword">long</span> stamp<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>可以看出<code>tryConvertToWriteLock</code> 方法表明StampedLock支持锁升级，这也是和<code>ReentrantReadWriteLock</code> 不同的点。</p> <h3 id="并发度比较"><a href="#并发度比较" class="header-anchor">#</a> 并发度比较</h3> <table><thead><tr><th>锁</th> <th>并发度</th></tr></thead> <tbody><tr><td>ReentrantLock</td> <td>读读互斥，读写互斥，写写互斥</td></tr> <tr><td>ReentrantReadWriteLock</td> <td>读读不互斥、读写互斥、写写互斥</td></tr> <tr><td>StampedLock</td> <td>读读不互斥、读写不互斥、写写互斥</td></tr></tbody></table> <p>上面对于StampedLock 的读写不互斥是指 乐观读和写，而不是悲观读和写。</p> <p>乐观读的思想和数据库中MVCC（Multi-Version Concurrency Control，多版本并发控制）有点类似。</p> <h2 id="_2、stampedlock简单使用示例"><a href="#_2、stampedlock简单使用示例" class="header-anchor">#</a> 2、StampedLock简单使用示例</h2> <p>还是拿狗吃骨头举例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">StampedLock</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestA</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StampedLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StampedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> bones <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// 初始骨头数量</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TestA</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建多个线程模拟狗的操作  可以吃骨头 也可以添加骨头</span>
        <span class="token class-name">Runnable</span> dogEat <span class="token operator">=</span> example<span class="token operator">::</span><span class="token function">eatBone</span><span class="token punctuation">;</span>
        <span class="token class-name">Runnable</span> dogAdd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> example<span class="token punctuation">.</span><span class="token function">addBones</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> dog1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>dogEat<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> dog3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>dogAdd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> dog2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>dogEat<span class="token punctuation">)</span><span class="token punctuation">;</span>

        dog1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dog2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dog3<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            dog1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dog2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dog3<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// 狗获取骨头（读操作）</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eatBone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryOptimisticRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 尝试进行乐观读操作</span>
            <span class="token keyword">int</span> currentBones <span class="token operator">=</span> bones<span class="token punctuation">;</span>
            <span class="token comment">// 这里模拟一些延迟</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 假设读操作需要一点时间</span>

            <span class="token comment">// 检查在读操作过程中骨头是否被修改</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 骨头在读操作过程中被修改，获取悲观读锁以确保一致性</span>
                stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 持有悲观读锁  bones 就不能被修改了</span>
                    currentBones <span class="token operator">=</span> bones<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    lock<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 输出读取到的骨头数量</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;狗看到的骨头数量 : &quot;</span> <span class="token operator">+</span> currentBones <span class="token operator">+</span> <span class="token string">&quot; 个&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 狗添加新的骨头（写操作）</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addBones</span><span class="token punctuation">(</span><span class="token keyword">int</span> number<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 执行写操作</span>
            bones <span class="token operator">+=</span> number<span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;添加 &quot;</span> <span class="token operator">+</span> number <span class="token operator">+</span> <span class="token string">&quot; 个骨头. 一共: &quot;</span> <span class="token operator">+</span> bones<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre></div><p>总结：<br>
需要注意的点就是，<code>lock.tryOptimisticRead();</code>获取悲观锁方法并不真正获取锁，而是假设在读操作期间数据不会被修改。使用戳记来验证数据是否在读操作期间被修改，必要时需要升级为悲观读锁来保证数据一致性。</p> <h3 id="使用乐观读锁需要遵循一定的规则"><a href="#使用乐观读锁需要遵循一定的规则" class="header-anchor">#</a> 使用乐观读锁需要遵循一定的规则：</h3> <p>比如吃骨头的方法中获取狗头数量的时候需要遵循下面几个步骤：
并且一定要按照下面几个步骤顺序处理。</p> <p><strong>①、乐观读操作：</strong>
先尝试使用 <code>tryOptimisticRead()</code> 获取乐观读锁。此时不持有实际的读锁，仅仅假设数据在读取期间不会被修改。<br>
进行乐观读操作，相当于把共享变量读取到线程的栈内存，这一步很重要需要在验证之前执行。</p> <p><strong>②、验证和转换：</strong><br>
使用 <code>validate(stamp)</code> 检查在乐观读期间数据是否被修改。如果数据未被修改，读取的结果就是可靠的。
如果数据被修改，需要使用 <code>readLock()</code> 获取悲观读锁，再进行一遍悲观读取操作来确保数据的一致性。</p> <p><strong>③、释放锁：</strong>
如果获取了悲观读锁，必须在读操作完成后使用 unlockRead(stamp) 释放锁。</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token comment">// 狗获取骨头（读操作）</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eatBone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryOptimisticRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 尝试进行乐观读操作</span>
            <span class="token keyword">int</span> currentBones <span class="token operator">=</span> bones<span class="token punctuation">;</span>
            <span class="token comment">// 这里模拟一些延迟</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 假设读操作需要一点时间</span>

            <span class="token comment">// 检查在读操作过程中骨头是否被修改</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 骨头在读操作过程中被修改，获取悲观读锁以确保一致性</span>
                stamp <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 持有悲观读锁  bones 就不能被修改了</span>
                    currentBones <span class="token operator">=</span> bones<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    lock<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 输出读取到的骨头数量</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;狗看到的骨头数量 : &quot;</span> <span class="token operator">+</span> currentBones <span class="token operator">+</span> <span class="token string">&quot; 个&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>使用乐观锁、悲观锁思想也是StampedLock提升读取性能的一个方式。因为<code>tryOptimisticRead</code>  和 <code>validate</code>这两个方法都比悲观读锁的CAS操作要快。</p> <h3 id="validate方法的注意点"><a href="#validate方法的注意点" class="header-anchor">#</a> <code>validate</code>方法的注意点</h3> <p>由于乐观读操作对顺序要求很严格，并且乐观读返回的是普通long类型变量，所以为了防止重排序，在<code>validate</code>方法中使用了读屏障（ <code>U.loadFence();</code>） 确保在屏障之前的所有读操作在屏障之后的读操作之前完成。这意味着，<code>U.loadFence()</code> 保证了在它之前的内存读取操作不会被重新排序到它之后。</p> <p><code>StampedLock</code>中的<code>state</code> 变量是volatile修饰的，但是validate方法的入参<code>stamp</code>并不能保证是volatile变量，所以需要加个读屏障，确保 <code>stamp</code> 和 <code>state</code> 的读取操作不会被重排序，从而保证 <code>stamp</code> 的有效性检查是准确的。如果不使用读屏障，可能会出现 <code>stamp</code> 和 <code>state</code> 的读取操作被重排序的情况，这可能导致 validate 方法返回不正确的结果。</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token keyword">long</span> stamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">loadFence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>stamp <span class="token operator">&amp;</span> <span class="token constant">SBITS</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>state <span class="token operator">&amp;</span> <span class="token constant">SBITS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h2 id="_3、stampedlock获取释放锁详解"><a href="#_3、stampedlock获取释放锁详解" class="header-anchor">#</a> 3、StampedLock获取释放锁详解</h2> <h3 id="类继承结构"><a href="#类继承结构" class="header-anchor">#</a> 类继承结构</h3> <img src="/blog/images/39-1.png" alt="mixureSecure"> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StampedLock</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span>
</code></pre></div><h3 id="类属性"><a href="#类属性" class="header-anchor">#</a> 类属性</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/** CPU 核心数，用于自旋控制 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NCPU</span> <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/** 尝试获取锁时的最大自旋次数。自旋是指在短时间内反复检查锁状态，而不是立即阻塞线程。 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SPINS</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">NCPU</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">/** 尝试获取锁时，最大自旋次数，超出此值后会尝试阻塞在队列的头部。 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">HEAD_SPINS</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">NCPU</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">/** 自旋时的最大重试次数，超出此值后会重新尝试阻塞。 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_HEAD_SPINS</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">NCPU</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">/** 等待溢出自旋锁时的放弃 CPU 使用的周期。这是一个幂次 2 - 1 的值。 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">OVERFLOW_YIELD_RATE</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token comment">// 必须是 2 的幂次 - 1</span>

<span class="token comment">/** 用于表示读锁计数的位数，超出此范围会发生溢出。  范围是1~126  */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">LG_READERS</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>

<span class="token comment">/** 锁状态和印章操作的相关常量值 */</span>

<span class="token comment">// 单位读操作的位掩码</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">RUNIT</span> <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

<span class="token comment">// 写操作的位掩码（位移了 LG_READERS 位）</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">WBIT</span>  <span class="token operator">=</span> <span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">LG_READERS</span><span class="token punctuation">;</span>

<span class="token comment">// 读操作的位掩码范围</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">RBITS</span> <span class="token operator">=</span> <span class="token constant">WBIT</span> <span class="token operator">-</span> <span class="token number">1L</span><span class="token punctuation">;</span>

<span class="token comment">// 读操作的满位掩码</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">RFULL</span> <span class="token operator">=</span> <span class="token constant">RBITS</span> <span class="token operator">-</span> <span class="token number">1L</span><span class="token punctuation">;</span>

<span class="token comment">// 所有锁的位掩码（包括读和写）</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">ABITS</span> <span class="token operator">=</span> <span class="token constant">RBITS</span> <span class="token operator">|</span> <span class="token constant">WBIT</span><span class="token punctuation">;</span>

<span class="token comment">// 只有写锁的位掩码 ( ~ 是按位取反操作符)</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">SBITS</span> <span class="token operator">=</span> <span class="token operator">~</span><span class="token constant">RBITS</span><span class="token punctuation">;</span> <span class="token comment">// 注意与 ABITS 的重叠</span>

<span class="token comment">// 锁状态的初始值; 避免零值作为失败值</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">ORIGIN</span> <span class="token operator">=</span> <span class="token constant">WBIT</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">/** 从被取消的获取方法返回的特殊值，用于抛出中断异常。 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">INTERRUPTED</span> <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

<span class="token comment">/** 节点状态的相关常量值，顺序很重要 */</span>

<span class="token comment">// 等待状态</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">WAITING</span>   <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">// 取消状态</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CANCELLED</span> <span class="token operator">=</span>  <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">/** 节点模式; 用整数而不是布尔值，以允许进行算术操作 */</span>

<span class="token comment">// 读模式</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">RMODE</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// 写模式</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">WMODE</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">/** 等待节点的内部类，用于管理队列中的节点 */</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">WNode</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token class-name">WNode</span> prev<span class="token punctuation">;</span>    <span class="token comment">// 上一个节点</span>
    <span class="token keyword">volatile</span> <span class="token class-name">WNode</span> next<span class="token punctuation">;</span>    <span class="token comment">// 下一个节点</span>
    <span class="token keyword">volatile</span> <span class="token class-name">WNode</span> cowait<span class="token punctuation">;</span>  <span class="token comment">// 链接的读线程列表</span>
    <span class="token keyword">volatile</span> <span class="token class-name">Thread</span> thread<span class="token punctuation">;</span> <span class="token comment">// 线程对象; 如果非空，则线程可能被挂起</span>
    <span class="token keyword">volatile</span> <span class="token keyword">int</span> status<span class="token punctuation">;</span>    <span class="token comment">// 节点状态; 0, WAITING 或 CANCELLED</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> mode<span class="token punctuation">;</span>         <span class="token comment">// 节点模式; RMODE 或 WMODE</span>
    <span class="token class-name">WNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> m<span class="token punctuation">,</span> <span class="token class-name">WNode</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span> mode <span class="token operator">=</span> m<span class="token punctuation">;</span> prev <span class="token operator">=</span> p<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/** CLH 队列的头部节点 */</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">WNode</span> whead<span class="token punctuation">;</span>

<span class="token comment">/** CLH 队列的尾部节点 */</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">WNode</span> wtail<span class="token punctuation">;</span>

<span class="token comment">/** 锁视图，用于提供不同类型的锁视图 */</span>
<span class="token keyword">transient</span> <span class="token class-name">ReadLockView</span> readLockView<span class="token punctuation">;</span>
<span class="token keyword">transient</span> <span class="token class-name">WriteLockView</span> writeLockView<span class="token punctuation">;</span>
<span class="token keyword">transient</span> <span class="token class-name">ReadWriteLockView</span> readWriteLockView<span class="token punctuation">;</span>

<span class="token comment">/** 锁的状态*/</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> state<span class="token punctuation">;</span>

<span class="token comment">/** 当状态的读计数饱和时，所使用的额外读锁计数 */</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">int</span> readerOverflow<span class="token punctuation">;</span>

</code></pre></div><p>可以看出<code>StampedLock</code>是通过内部类 <code>WNode</code> 来管理队列中的节点(队列属于双向链表结构，利用了CLH锁思想)。并且用了大量的标志位和位运算来处理锁的逻辑。  CLH锁的详解可以参考 <a href="https://deepjava.blog.csdn.net/article/details/140123293" target="_blank" rel="noopener noreferrer">AQS详解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>这篇文章。</p> <h3 id="stampedlock对于state变量的设计"><a href="#stampedlock对于state变量的设计" class="header-anchor">#</a> StampedLock对于state变量的设计</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/** 用于表示读锁计数的位数，超出此范围会发生溢出。  范围是1~126  */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">LG_READERS</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
<span class="token comment">// 写操作的位掩码（位移了 LG_READERS 位）</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">WBIT</span>  <span class="token operator">=</span> <span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">LG_READERS</span><span class="token punctuation">;</span>
<span class="token comment">// 锁状态的初始值; 避免零值作为失败值</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">ORIGIN</span> <span class="token operator">=</span> <span class="token constant">WBIT</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">/** 锁的状态*/</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> state<span class="token punctuation">;</span>
</code></pre></div><p>由于只有一个<code>state</code>变量，又需要表示读写锁，所以<code>StampedLock</code>也把state变量拆成了读和写的部分，但是不同于 <code>ReentrantReadWriteLock</code>的int类型的state变量把高16位表示读锁计数，低16位表示写锁计数。</p> <p><code>StampedLock</code>中 锁状态的初始值是 <code>ORIGIN</code> 也就是 1&lt;&lt;7,也就是 <code>1000 0000</code>（前面的0省略）<br>
用最低的8位表示读和写的状态，其中最低的7位表示读锁的状态(版本)，第8位表示写锁的状态。
因为写锁是互斥的且不可重入，用一位就够了。</p> <h3 id="stampedlock乐观锁实现原理"><a href="#stampedlock乐观锁实现原理" class="header-anchor">#</a> StampedLock乐观锁实现原理</h3> <p>结合<code>tryOptimisticRead</code>和<code>validate</code>方法分析：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">tryOptimisticRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> s<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> state<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">WBIT</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>s <span class="token operator">&amp;</span> <span class="token constant">SBITS</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token keyword">long</span> stamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">loadFence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>stamp <span class="token operator">&amp;</span> <span class="token constant">SBITS</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>state <span class="token operator">&amp;</span> <span class="token constant">SBITS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><code>tryOptimisticRead</code>方法中 <code>state&amp;WBIT！=0</code>，说明<code>state</code>变量表示写锁的第八位为1，也就是有线程持有写锁，那么<code>tryOptimisticRead</code>方法就会返回0。表示获取乐观读锁失败。然后我们再调用<code>validate(0)</code>一定会得到false，也就是校验失败。这个符合当有线程持有写锁时与其他锁互斥的逻辑。</p> <p>为什么<code>validate</code>方法，比较的是<code>(stamp &amp; SBITS) == (state &amp; SBITS);</code>？<br>
因为需要支持读读不互斥，即使修改了state的低7位也就是读锁的部分，<code>(stamp &amp; SBITS) == (state &amp; SBITS);</code>依然会返回true。</p> <h3 id="stampedlock的构造方法"><a href="#stampedlock的构造方法" class="header-anchor">#</a> StampedLock的构造方法</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/** 用于表示读锁状态的位数，超出此范围会发生溢出。  范围是1~126  */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">LG_READERS</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>

<span class="token comment">/** 写操作的位掩码（位移了 LG_READERS 位） */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">WBIT</span>  <span class="token operator">=</span> <span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">LG_READERS</span><span class="token punctuation">;</span>

<span class="token comment">/** 锁状态的初始值; 避免零值作为失败值 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">ORIGIN</span> <span class="token operator">=</span> <span class="token constant">WBIT</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">/** 锁的状态*/</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> state<span class="token punctuation">;</span>

<span class="token comment">/**
 * 默认构造方法。
 * 初始化 `StampedLock` 对象，将锁状态设置为初始值。
 */</span>
<span class="token keyword">public</span> <span class="token class-name">StampedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始化锁状态为初始值 ORIGIN，避免状态为零作为失败值。</span>
    state <span class="token operator">=</span> <span class="token constant">ORIGIN</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="tryoptimisticread方法"><a href="#tryoptimisticread方法" class="header-anchor">#</a> <code>tryOptimisticRead</code>方法</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/** 用于表示读锁状态的位数 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">LG_READERS</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>

<span class="token comment">/** 写操作的位掩码（位移了 LG_READERS 位） */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">WBIT</span>  <span class="token operator">=</span> <span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">LG_READERS</span><span class="token punctuation">;</span>

<span class="token comment">/** 只有写锁的位掩码 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">SBITS</span> <span class="token operator">=</span> <span class="token operator">~</span><span class="token constant">RBITS</span><span class="token punctuation">;</span>

<span class="token comment">/** 读操作的位掩码范围 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">RBITS</span> <span class="token operator">=</span> <span class="token constant">WBIT</span> <span class="token operator">-</span> <span class="token number">1L</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 尝试以乐观读模式获取锁。
 * 
 * 这个方法检查当前锁状态以确定是否可以进行乐观读操作。
 * 如果没有写锁持有者（即锁的写位没有被设置），方法返回当前的读者计数（即锁的状态）。
 * 否则，返回 0 表示无法进行乐观读操作。
 * 
 * @return 如果可以进行乐观读，则返回当前的读者计数；否则返回 0。
 */</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">tryOptimisticRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> s<span class="token punctuation">;</span>
    <span class="token comment">// 读取当前锁状态</span>
    s <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token comment">// 检查写锁位是否被设置。如果没有写锁持有者（写位为 0），则返回当前读者计数（即去除写锁位后的状态值）。</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">&amp;</span> <span class="token constant">WBIT</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>s <span class="token operator">&amp;</span> <span class="token constant">SBITS</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个方法允许线程在没有写锁持有者的情况下进行乐观读操作，这可以提高并发性能，因为乐观读操作不需要获取实际的读锁。</p> <h3 id="readlock-方法"><a href="#readlock-方法" class="header-anchor">#</a> <code>readLock</code> 方法</h3> <p><strong>readLock方法</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 尝试获取读锁。
 * 
 * 在常见的无竞争情况下，这个方法会直接返回一个读锁的印章。
 * 如果当前队列为空（即 `whead` 等于 `wtail`），并且没有写锁持有者（即当前状态的读位小于 RFULL），
 * 则通过 CAS 操作将状态值加上 `RUNIT` 以尝试获取读锁。
 * 否则，调用 `acquireRead` 方法来实际获取读锁。
 * 
 * @return 成功获取读锁时的印章值。如果无法获取，则调用 `acquireRead` 方法来处理。
 */</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> s <span class="token operator">=</span> state<span class="token punctuation">,</span> next<span class="token punctuation">;</span>  <span class="token comment">// 读取当前锁状态，并为下一个状态准备变量</span>
    <span class="token comment">// 如果当前队列为空且状态值允许新的读操作，则尝试通过 CAS 操作增加读锁计数</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>whead <span class="token operator">==</span> wtail <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>s <span class="token operator">&amp;</span> <span class="token constant">ABITS</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">RFULL</span> <span class="token operator">&amp;&amp;</span>
             <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">STATE</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> next <span class="token operator">=</span> s <span class="token operator">+</span> <span class="token constant">RUNIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span>
            next <span class="token operator">:</span> <span class="token function">acquireRead</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 否则调用 acquireRead 方法来获取读锁</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong><code>readLock</code> 方法总结：</strong> <strong>目标：</strong> 尝试在无竞争情况下快速获取读锁。如果直接获取失败，则调用 <code>acquireRead</code> 处理复杂情况。</p> <p><strong>具体步骤：</strong></p> <p><strong>检查队列状态：</strong><br>
如果队列为空（whead == wtail）且状态允许增加读锁计数（(s &amp; ABITS) &lt; RFULL），即没有达到读锁计数上限：<br>
尝试通过 CAS 操作将 state 增加 RUNIT，即增加读锁计数。<br>
如果 CAS 操作成功，返回新的状态 next。</p> <p><strong>调用 acquireRead：</strong><br>
如果队列不为空，或者 CAS 操作失败，则调用 acquireRead 方法来处理更复杂的情况，实际获取读锁。</p> <p><strong>acquireRead方法</strong><br>
这个方法就开始上强度了，不太好理解</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 实际获取读锁的方法。
 * 
 * 这个方法会尝试获取读锁。如果直接获取失败，它会通过自旋、队列管理和线程等待来确保获取读锁。
 * 
 * @param interruptible 是否可中断。
 * @param deadline 线程等待的截止时间（纳秒）。
 * @return 成功获取读锁时的印章值。如果超时或中断，则可能会取消等待。
 */</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">acquireRead</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> interruptible<span class="token punctuation">,</span> <span class="token keyword">long</span> deadline<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">WNode</span> node <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> p<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> spins <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">WNode</span> h<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">=</span> whead<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> wtail<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 检查队列是否为空</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> m<span class="token punctuation">,</span> s<span class="token punctuation">,</span> ns<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 检查当前状态是否允许增加读锁计数</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> state<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">ABITS</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">RFULL</span> <span class="token operator">?</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">STATE</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> ns <span class="token operator">=</span> s <span class="token operator">+</span> <span class="token constant">RUNIT</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                    <span class="token punctuation">(</span>m <span class="token operator">&lt;</span> <span class="token constant">WBIT</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ns <span class="token operator">=</span> <span class="token function">tryIncReaderOverflow</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> ns<span class="token punctuation">;</span>  <span class="token comment">// 成功获取读锁</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">&gt;=</span> <span class="token constant">WBIT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">nextSecondarySeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                            <span class="token operator">--</span>spins<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">WNode</span> nh <span class="token operator">=</span> whead<span class="token punctuation">,</span> np <span class="token operator">=</span> wtail<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nh <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span> np <span class="token operator">==</span> p<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> nh<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> np<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        spins <span class="token operator">=</span> <span class="token constant">SPINS</span><span class="token punctuation">;</span>  <span class="token comment">// 重置自旋次数</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果队列为空，初始化队列</span>
            <span class="token class-name">WNode</span> hd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WNode</span><span class="token punctuation">(</span><span class="token constant">WMODE</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">WHEAD</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> hd<span class="token punctuation">)</span><span class="token punctuation">)</span>
                wtail <span class="token operator">=</span> hd<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WNode</span><span class="token punctuation">(</span><span class="token constant">RMODE</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 创建新的读节点</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> p <span class="token operator">||</span> p<span class="token punctuation">.</span>mode <span class="token operator">!=</span> <span class="token constant">RMODE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 如果队列中的前驱节点不是读节点，尝试加入队列</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>prev <span class="token operator">!=</span> p<span class="token punctuation">)</span>
                node<span class="token punctuation">.</span>prev <span class="token operator">=</span> p<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">WTAIL</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                p<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token constant">WCOWAIT</span><span class="token punctuation">,</span>
                                         node<span class="token punctuation">.</span>cowait <span class="token operator">=</span> p<span class="token punctuation">.</span>cowait<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span>
            node<span class="token punctuation">.</span>cowait <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  <span class="token comment">// 更新前驱节点的等待列表</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">WNode</span> pp<span class="token punctuation">,</span> c<span class="token punctuation">;</span> <span class="token class-name">Thread</span> w<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">=</span> whead<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">=</span> h<span class="token punctuation">.</span>cowait<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token constant">WCOWAIT</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>cowait<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span>w <span class="token operator">=</span> c<span class="token punctuation">.</span>thread<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token comment">// 唤醒等待线程</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> <span class="token punctuation">(</span>pp <span class="token operator">=</span> p<span class="token punctuation">.</span>prev<span class="token punctuation">)</span> <span class="token operator">||</span> h <span class="token operator">==</span> p <span class="token operator">||</span> pp <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">long</span> m<span class="token punctuation">,</span> s<span class="token punctuation">,</span> ns<span class="token punctuation">;</span>
                    <span class="token keyword">do</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 检查状态是否允许增加读锁计数</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> state<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">ABITS</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">RFULL</span> <span class="token operator">?</span>
                            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">STATE</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span>
                                                 ns <span class="token operator">=</span> s <span class="token operator">+</span> <span class="token constant">RUNIT</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                            <span class="token punctuation">(</span>m <span class="token operator">&lt;</span> <span class="token constant">WBIT</span> <span class="token operator">&amp;&amp;</span>
                             <span class="token punctuation">(</span>ns <span class="token operator">=</span> <span class="token function">tryIncReaderOverflow</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token keyword">return</span> ns<span class="token punctuation">;</span>  <span class="token comment">// 成功获取读锁</span>
                    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>m <span class="token operator">&lt;</span> <span class="token constant">WBIT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>whead <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>prev <span class="token operator">==</span> pp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">long</span> time<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pp <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> h <span class="token operator">==</span> p <span class="token operator">||</span> p<span class="token punctuation">.</span>status <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        node <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 丢弃节点</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>deadline <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span>
                        time <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>time <span class="token operator">=</span> deadline <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0L</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token function">cancelWaiter</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 超时取消等待</span>
                    <span class="token class-name">Thread</span> wt <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> <span class="token constant">PARKBLOCKER</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    node<span class="token punctuation">.</span>thread <span class="token operator">=</span> wt<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">!=</span> pp <span class="token operator">||</span> <span class="token punctuation">(</span>state <span class="token operator">&amp;</span> <span class="token constant">ABITS</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">WBIT</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                        whead <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>prev <span class="token operator">==</span> pp<span class="token punctuation">)</span>
                        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 线程等待</span>
                    node<span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> <span class="token constant">PARKBLOCKER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>interruptible <span class="token operator">&amp;&amp;</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token function">cancelWaiter</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 处理中断</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 在队列头部自旋等待</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> spins <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">WNode</span> h<span class="token punctuation">,</span> np<span class="token punctuation">,</span> pp<span class="token punctuation">;</span> <span class="token keyword">int</span> ps<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">=</span> whead<span class="token punctuation">)</span> <span class="token operator">==</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                spins <span class="token operator">=</span> <span class="token constant">HEAD_SPINS</span><span class="token punctuation">;</span>  <span class="token comment">// 初始化自旋次数</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">&lt;</span> <span class="token constant">MAX_HEAD_SPINS</span><span class="token punctuation">)</span>
                spins <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 增加自旋次数</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> spins<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 在队列头部自旋</span>
                <span class="token keyword">long</span> m<span class="token punctuation">,</span> s<span class="token punctuation">,</span> ns<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> state<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">ABITS</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">RFULL</span> <span class="token operator">?</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">STATE</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> ns <span class="token operator">=</span> s <span class="token operator">+</span> <span class="token constant">RUNIT</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                    <span class="token punctuation">(</span>m <span class="token operator">&lt;</span> <span class="token constant">WBIT</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>ns <span class="token operator">=</span> <span class="token function">tryIncReaderOverflow</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">WNode</span> c<span class="token punctuation">;</span> <span class="token class-name">Thread</span> w<span class="token punctuation">;</span>
                    whead <span class="token operator">=</span> node<span class="token punctuation">;</span>  <span class="token comment">// 更新队列头部</span>
                    node<span class="token punctuation">.</span>prev <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> node<span class="token punctuation">.</span>cowait<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token constant">WCOWAIT</span><span class="token punctuation">,</span>
                                                   c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>cowait<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                            <span class="token punctuation">(</span>w <span class="token operator">=</span> c<span class="token punctuation">.</span>thread<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 唤醒等待线程</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> ns<span class="token punctuation">;</span>  <span class="token comment">// 成功获取读锁</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">&gt;=</span> <span class="token constant">WBIT</span> <span class="token operator">&amp;&amp;</span>
                         <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">nextSecondarySeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">--</span>k <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token comment">// 超过自旋次数，退出自旋</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">WNode</span> c<span class="token punctuation">;</span> <span class="token class-name">Thread</span> w<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> h<span class="token punctuation">.</span>cowait<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token constant">WCOWAIT</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>cowait<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span>w <span class="token operator">=</span> c<span class="token punctuation">.</span>thread<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 唤醒等待线程</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>whead <span class="token operator">==</span> h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>np <span class="token operator">=</span> node<span class="token punctuation">.</span>prev<span class="token punctuation">)</span> <span class="token operator">!=</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>np <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token punctuation">(</span>p <span class="token operator">=</span> np<span class="token punctuation">)</span><span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>   <span class="token comment">// 更新前驱节点的 next 指针</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ps <span class="token operator">=</span> p<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token constant">WSTATUS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">WAITING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 设置节点状态为等待</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ps <span class="token operator">==</span> <span class="token constant">CANCELLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pp <span class="token operator">=</span> p<span class="token punctuation">.</span>prev<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pp<span class="token punctuation">;</span>
                    pp<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>  <span class="token comment">// 更新前驱节点的 next 指针</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> time<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>deadline <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span>
                    time <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>time <span class="token operator">=</span> deadline <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0L</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token function">cancelWaiter</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> node<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 超时取消等待</span>
                <span class="token class-name">Thread</span> wt <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> <span class="token constant">PARKBLOCKER</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                node<span class="token punctuation">.</span>thread <span class="token operator">=</span> wt<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span>p <span class="token operator">!=</span> h <span class="token operator">||</span> <span class="token punctuation">(</span>state <span class="token operator">&amp;</span> <span class="token constant">ABITS</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">WBIT</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    whead <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>prev <span class="token operator">==</span> p<span class="token punctuation">)</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 线程等待</span>
                node<span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> <span class="token constant">PARKBLOCKER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>interruptible <span class="token operator">&amp;&amp;</span>
</code></pre></div><p><strong>acquireRead 方法总结：</strong><br> <strong>目标：</strong> 在有竞争的情况下获取读锁，包括处理线程等待、队列管理、自旋等。</p> <p><strong>acquireRead 的详细步骤：</strong></p> <p><strong>检查队列状态：</strong><br>
如果队列为空（whead == wtail），尝试直接增加读锁计数（state）。<br>
如果成功，返回新的状态 ns。否则，进行自旋尝试。</p> <p><strong>创建或管理节点：</strong><br>
如果队列为空，初始化一个新的头节点。<br>
如果节点 node 为空，则创建一个新的读节点。<br>
尝试将新的读节点添加到队列中，处理节点前驱和队列管理。</p> <p><strong>处理自旋等待：</strong><br>
如果直接获取读锁失败，通过自旋等待的方式尝试获取读锁。</p> <p><strong>处理线程等待：</strong><br>
如果自旋仍然失败，将线程放入等待队列中，处理中断和超时。</p> <p><strong>唤醒等待线程：</strong><br>
当读锁被成功获取后，唤醒等待的线程。</p> <h3 id="unlockread方法"><a href="#unlockread方法" class="header-anchor">#</a> unlockRead方法</h3> <p><strong>unlockRead方法</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 解锁读锁。
 * 
 * 这个方法会验证提供的印章（`stamp`）是否与当前锁状态一致。如果印章无效或锁状态不匹配，会抛出 `IllegalMonitorStateException`。
 * 如果锁的读计数低于 `RFULL`，尝试通过 CAS 操作减少读计数。如果读计数减少到 0，则释放队列中可能被阻塞的线程。
 * 如果读计数达到了 `RFULL`，则调用 `tryDecReaderOverflow` 方法来处理溢出读线程计数。
 * 
 * @param stamp 读锁的印章值。
 * @throws IllegalMonitorStateException 如果印章无效或状态不匹配。
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlockRead</span><span class="token punctuation">(</span><span class="token keyword">long</span> stamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> s<span class="token punctuation">,</span> m<span class="token punctuation">;</span> <span class="token class-name">WNode</span> h<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 自旋</span>
        <span class="token comment">// 获取当前锁状态</span>
        s <span class="token operator">=</span> state<span class="token punctuation">;</span>
        <span class="token comment">// 检查印章是否与当前状态匹配，或者印章是否有效</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">&amp;</span> <span class="token constant">SBITS</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>stamp <span class="token operator">&amp;</span> <span class="token constant">SBITS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token punctuation">(</span>stamp <span class="token operator">&amp;</span> <span class="token constant">ABITS</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0L</span> <span class="token operator">||</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> s <span class="token operator">&amp;</span> <span class="token constant">ABITS</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0L</span> <span class="token operator">||</span> m <span class="token operator">==</span> <span class="token constant">WBIT</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 印章无效，抛出异常</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">&lt;</span> <span class="token constant">RFULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果读计数小于 RFULL，尝试减少读计数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">STATE</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> s <span class="token operator">-</span> <span class="token constant">RUNIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果减少后读计数为 RUNIT 且队列头部节点状态不为 0，释放队列中的线程</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token constant">RUNIT</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> whead<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>status <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token function">release</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryDecReaderOverflow</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0L</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token comment">// 处理溢出的读者计数</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong><code>unlockRead</code> 方法总结：</strong></p> <p><code>目标：</code>释放读锁，验证印章的有效性，并根据读锁计数的状态更新锁状态。</p> <p><strong>步骤：</strong><br> <strong>自旋检查印章有效性：</strong><br>
进入自旋循环，获取当前锁状态 s。<br>
检查传入的印章 stamp 是否与当前状态一致（通过比较 SBITS），以及印章是否有效<code>（(stamp &amp; ABITS) == 0L）</code>，或者当前状态是否无效<code>（m == WBIT）</code>。<br>
如果印章无效，抛出 IllegalMonitorStateException。</p> <p><strong>处理读计数：</strong><br>
如果读计数小于 RFULL：<br>
尝试通过 CAS 操作将状态 s 减少 RUNIT，即减少读锁计数。<br>
如果读计数减少后为 RUNIT，并且队列头部节点状态不为 0，调用 release(h) 释放队列中的线程。<br>
跳出循环，完成解锁。</p> <p>如果读计数达到 RFULL：<br>
调用 tryDecReaderOverflow 方法处理读计数溢出情况。</p> <p><strong>处理读计数溢出：</strong><br>
tryDecReaderOverflow 方法用于减少在 RFULL 状态下的溢出读线程计数。</p> <p><strong>tryDecReaderOverflow方法</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 尝试减少溢出的读者计数。
 * 
 * 这个方法会处理在读锁计数达到 `RFULL` 后的溢出情况。如果当前状态的读计数已经达到 `RFULL`，
 * 通过 CAS 操作将状态更新为包含读位的值，并减少 `readerOverflow` 计数器。
 * 如果 `readerOverflow` 计数器为 0，则直接减少读计数。
 * 
 * @param s 当前锁状态。
 * @return 更新后的状态值。如果无法减少读者计数，则返回 0L。
 */</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">tryDecReaderOverflow</span><span class="token punctuation">(</span><span class="token keyword">long</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 确保当前状态的读位计数达到了 RFULL</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">&amp;</span> <span class="token constant">ABITS</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">RFULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过 CAS 操作将状态值更新为包含读位的状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">STATE</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> s <span class="token operator">|</span> <span class="token constant">RBITS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> r<span class="token punctuation">;</span> <span class="token keyword">long</span> next<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> readerOverflow<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果溢出计数器大于 0，减少计数器并保持状态</span>
                readerOverflow <span class="token operator">=</span> r <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                next <span class="token operator">=</span> s<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
                <span class="token comment">// 否则，减少读锁计数</span>
                next <span class="token operator">=</span> s <span class="token operator">-</span> <span class="token constant">RUNIT</span><span class="token punctuation">;</span>
            state <span class="token operator">=</span> next<span class="token punctuation">;</span>  <span class="token comment">// 更新锁状态</span>
            <span class="token keyword">return</span> next<span class="token punctuation">;</span>  <span class="token comment">// 返回更新后的状态值</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">nextSecondarySeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">OVERFLOW_YIELD_RATE</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 在不能处理溢出时，让线程让步</span>
    <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>  <span class="token comment">// 无法减少读者计数时返回 0L</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>tryDecReaderOverflow方法总结：</strong></p> <p><strong>目标：</strong> 处理在读锁计数达到上限时的溢出情况，确保锁状态的正确性。</p> <p><strong>步骤：</strong> <strong>检查读计数是否达到 RFULL：</strong><br>
如果当前状态的读位计数等于 RFULL，则尝试更新状态以处理溢出情况。</p> <p><strong>更新状态：</strong>
通过 CAS 操作将状态更新为包含读位的状态<code>（s | RBITS）</code>。<br>
如果 readerOverflow 计数器大于 0，减少计数器并保持状态。<br>
如果 readerOverflow 为 0，减少读锁计数。<br>
更新 state 变量，并返回更新后的状态值。</p> <p><strong>处理无法减少计数的情况：</strong><br>
如果无法处理溢出情况，让线程让步（Thread.yield()），并返回 0L。</p> <h3 id="writelock-方法"><a href="#writelock-方法" class="header-anchor">#</a> <code>writeLock</code> 方法</h3> <p><strong>writeLock方法</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 尝试获取写锁。
 * 
 * 这个方法首先检查当前锁状态，如果当前没有读锁或写锁（`ABITS` 中没有任何标志位），
 * 直接通过 CAS 操作将状态更新为加上写锁位 `WBIT` 的新状态。如果更新成功，返回新的状态值。
 * 如果锁已被其他线程持有，或者队列中存在等待写锁的线程，则调用 `acquireWrite` 方法，
 * 通过排队的方式来获取写锁。
 * 
 * @return 成功获取的写锁印章。
 */</span>
<span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> s<span class="token punctuation">,</span> next<span class="token punctuation">;</span>  <span class="token comment">// 当前锁状态和新的状态</span>
    <span class="token comment">// 检查当前锁状态是否为完全解锁状态</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> state<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">ABITS</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0L</span> <span class="token operator">&amp;&amp;</span>
             <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">STATE</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> next <span class="token operator">=</span> s <span class="token operator">+</span> <span class="token constant">WBIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span>
            next <span class="token operator">:</span> <span class="token function">acquireWrite</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>writeLock 方法总结：</strong> <strong>目标：</strong>  writeLock 方法尝试直接获取写锁，如果失败则调用 acquireWrite 方法通过排队的方式获取写锁。</p> <p><strong>步骤：</strong><br> <strong>检查当前锁状态：</strong>
获取当前锁状态 s。<br>
如果当前状态没有任何读锁或写锁（即 ABITS 中没有任何标志位），尝试通过 CAS 操作将状态更新为加上写锁位 WBIT 的新状态 next。</p> <p><strong>更新锁状态：</strong><br>
如果 CAS 操作成功，则返回新的状态值 next。</p> <p><strong>调用 acquireWrite：</strong><br>
如果状态更新失败（锁已被其他线程持有或队列中存在等待写锁的线程），调用 acquireWrite 方法来通过排队的方式获取写锁。</p> <p><strong>acquireWrite方法</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 尝试获取写锁。
 * 
 * 这个方法通过自旋和排队的方式获取写锁。如果直接获取写锁失败，则将当前线程排入等待队列，
 * 并在队列中等待直到能够获取写锁。
 * 
 * @param interruptible 是否可中断。
 * @param deadline 等待的最大时间（以纳秒为单位），0 表示不超时。
 * @return 成功获取的写锁印章。
 */</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">acquireWrite</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> interruptible<span class="token punctuation">,</span> <span class="token keyword">long</span> deadline<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">WNode</span> node <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> p<span class="token punctuation">;</span>

    <span class="token comment">// 自旋尝试将当前线程排入等待队列</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> spins <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 自旋，直到将节点加入队列</span>
        <span class="token keyword">long</span> m<span class="token punctuation">,</span> s<span class="token punctuation">,</span> ns<span class="token punctuation">;</span>

        <span class="token comment">// 获取当前锁状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">=</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> state<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">ABITS</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果当前没有读锁或写锁，通过 CAS 操作将状态更新为加上写锁位 WBIT</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">STATE</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> ns <span class="token operator">=</span> s <span class="token operator">+</span> <span class="token constant">WBIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> ns<span class="token punctuation">;</span>  <span class="token comment">// 返回更新后的状态值</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment">// 如果当前状态为写锁且队列为空，设置自旋次数</span>
            spins <span class="token operator">=</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token constant">WBIT</span> <span class="token operator">&amp;&amp;</span> wtail <span class="token operator">==</span> whead<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">SPINS</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 自旋，减少自旋次数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">nextSecondarySeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token operator">--</span>spins<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> wtail<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 初始化队列</span>
            <span class="token class-name">WNode</span> hd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WNode</span><span class="token punctuation">(</span><span class="token constant">WMODE</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">WHEAD</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> hd<span class="token punctuation">)</span><span class="token punctuation">)</span>
                wtail <span class="token operator">=</span> hd<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token comment">// 创建新的等待节点</span>
            node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WNode</span><span class="token punctuation">(</span><span class="token constant">WMODE</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>prev <span class="token operator">!=</span> p<span class="token punctuation">)</span>
            <span class="token comment">// 确保节点的前驱节点正确</span>
            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">WTAIL</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 将当前节点加入队列</span>
            p<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token comment">// 成功将节点加入队列，退出自旋循环</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 自旋等待，直到获取写锁</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> spins <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">WNode</span> h<span class="token punctuation">,</span> np<span class="token punctuation">,</span> pp<span class="token punctuation">;</span>
        <span class="token keyword">int</span> ps<span class="token punctuation">;</span>

        <span class="token comment">// 检查当前队列头节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">=</span> whead<span class="token punctuation">)</span> <span class="token operator">==</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果当前节点是队列头节点，自旋等待写锁</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                spins <span class="token operator">=</span> <span class="token constant">HEAD_SPINS</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>spins <span class="token operator">&lt;</span> <span class="token constant">MAX_HEAD_SPINS</span><span class="token punctuation">)</span>
                spins <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> spins<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> s<span class="token punctuation">,</span> ns<span class="token punctuation">;</span>
                <span class="token comment">// 获取当前锁状态</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> state<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token constant">ABITS</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 如果当前没有读锁或写锁，通过 CAS 操作更新状态</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">STATE</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> ns <span class="token operator">=</span> s <span class="token operator">+</span> <span class="token constant">WBIT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 更新队列头部为当前节点</span>
                        whead <span class="token operator">=</span> node<span class="token punctuation">;</span>
                        node<span class="token punctuation">.</span>prev <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> ns<span class="token punctuation">;</span>  <span class="token comment">// 返回新的状态值</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">nextSecondarySeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                         <span class="token operator">--</span>k <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token comment">// 超过自旋次数，退出循环</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 帮助释放过时的等待节点</span>
            <span class="token class-name">WNode</span> c<span class="token punctuation">;</span>
            <span class="token class-name">Thread</span> w<span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> h<span class="token punctuation">.</span>cowait<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token constant">WCOWAIT</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>cowait<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token punctuation">(</span>w <span class="token operator">=</span> c<span class="token punctuation">.</span>thread<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>whead <span class="token operator">==</span> h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>np <span class="token operator">=</span> node<span class="token punctuation">.</span>prev<span class="token punctuation">)</span> <span class="token operator">!=</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 更新链表，将当前节点插入到正确的位置</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>np <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token punctuation">(</span>p <span class="token operator">=</span> np<span class="token punctuation">)</span><span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>   <span class="token comment">// 处理过时的节点</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ps <span class="token operator">=</span> p<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token comment">// 如果节点状态为 0，设置为 WAITING</span>
                <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token constant">WSTATUS</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">WAITING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ps <span class="token operator">==</span> <span class="token constant">CANCELLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 如果节点状态为 CANCELLED，处理取消的节点</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pp <span class="token operator">=</span> p<span class="token punctuation">.</span>prev<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pp<span class="token punctuation">;</span>
                    pp<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 等待获取写锁</span>
                <span class="token keyword">long</span> time<span class="token punctuation">;</span> <span class="token comment">// 0 参数表示无超时</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>deadline <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span>
                    time <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>time <span class="token operator">=</span> deadline <span class="token operator">-</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0L</span><span class="token punctuation">)</span>
                    <span class="token comment">// 超过等待时间，取消等待</span>
                    <span class="token keyword">return</span> <span class="token function">cancelWaiter</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> node<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Thread</span> wt <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> <span class="token constant">PARKBLOCKER</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                node<span class="token punctuation">.</span>thread <span class="token operator">=</span> wt<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> h <span class="token operator">||</span> <span class="token punctuation">(</span>state <span class="token operator">&amp;</span> <span class="token constant">ABITS</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0L</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    whead <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>prev <span class="token operator">==</span> p<span class="token punctuation">)</span>
                    <span class="token comment">// 如果条件满足，则使当前线程进入等待状态</span>
                    <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 模拟 LockSupport.park</span>
                node<span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> <span class="token constant">PARKBLOCKER</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>interruptible <span class="token operator">&amp;&amp;</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token comment">// 如果线程被中断，取消等待</span>
                    <span class="token keyword">return</span> <span class="token function">cancelWaiter</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> node<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>acquireWrite 方法总结：</strong> <strong>目标：</strong>  负责处理排队、等待和自旋等复杂逻辑，确保在竞争条件下正确地获取写锁。</p> <p><strong>步骤：</strong></p> <p><strong>自旋排队:</strong><br>
方法开始时，尝试通过自旋的方式将当前线程排入等待队列。如果当前没有读锁或写锁，尝试直接获取写锁。如果无法直接获取写锁，初始化队列或创建新的等待节点，将其添加到队列中。</p> <p><strong>等待队列初始化:</strong><br>
如果队列为空，创建队列头节点，并将尾节点指向该头节点。若节点已经存在，则创建新的节点并将其加入队列。</p> <p><strong>自旋等待写锁:</strong><br>
在自旋阶段，尝试检查队列头节点并自旋等待写锁。更新队列头节点为当前节点，确保其他线程能够正确地获取写锁。</p> <p><strong>处理过时的等待节点:</strong><br>
在等待期间，帮助释放已经过时的等待节点，并唤醒那些被阻塞的线程。</p> <p><strong>等待获取写锁:</strong><br>
如果条件允许，将当前线程进入等待状态，直到写锁可用。支持中断处理，如果线程被中断则取消等待。</p> <h3 id="unlockwrite方法"><a href="#unlockwrite方法" class="header-anchor">#</a> unlockWrite方法</h3> <p><strong>unlockWrite方法</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 解锁写锁。
 * 
 * 这个方法会验证提供的印章（`stamp`）是否为当前锁的写锁印章。如果印章无效或不是写锁印章，会抛出 `IllegalMonitorStateException`。
 * 成功解锁后，将状态重置为原始值 `ORIGIN`（如果 `stamp` 变为 0L），或者恢复为提供的印章加上写锁位 `WBIT`。
 * 如果队列头部节点（`whead`）不为空且状态不为 0，则调用 `release` 方法释放队列中可能被阻塞的线程。
 * 
 * @param stamp 写锁的印章值。
 * @throws IllegalMonitorStateException 如果印章无效或不是写锁印章。
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlockWrite</span><span class="token punctuation">(</span><span class="token keyword">long</span> stamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">WNode</span> h<span class="token punctuation">;</span>
    <span class="token comment">// 验证提供的印章是否与当前锁状态匹配，并且是写锁印章</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> stamp <span class="token operator">||</span> <span class="token punctuation">(</span>stamp <span class="token operator">&amp;</span> <span class="token constant">WBIT</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0L</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 印章无效，抛出异常</span>

    <span class="token comment">// 更新锁状态。如果解锁后状态为 0L，重置为原始值 ORIGIN</span>
    state <span class="token operator">=</span> <span class="token punctuation">(</span>stamp <span class="token operator">+=</span> <span class="token constant">WBIT</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0L</span> <span class="token operator">?</span> <span class="token constant">ORIGIN</span> <span class="token operator">:</span> stamp<span class="token punctuation">;</span>
    
    <span class="token comment">// 如果队列头部节点不为空且状态不为 0，释放队列中的线程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">=</span> whead<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>status <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">release</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>unlockWrite方法总结：</strong> <strong>目标：</strong>  安全地释放持有的写锁，并确保相关线程被正确唤醒。</p> <p><strong>步骤：</strong><br> <strong>验证印章:</strong><br>
首先，方法会检查提供的印章是否与当前锁状态匹配，且印章是否包含写锁位 (WBIT)。如果不匹配或不包含写锁位，抛出 IllegalMonitorStateException。</p> <p><strong>更新锁状态:</strong>
如果印章有效，解锁后将状态重置为原始值 ORIGIN（如果 stamp 加上 WBIT 结果为 0L），否则将状态更新为印章加上 WBIT。这个操作确保锁的状态正确反映当前的锁持有情况。</p> <p><strong>释放阻塞线程:</strong>
检查队列头部节点 (whead) 是否存在且状态不为 0。如果存在，则调用 release 方法尝试释放队列中的线程。</p> <p><strong>release方法</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 释放队列中阻塞的线程。
 * 
 * 这个方法会尝试从队列中找到下一个需要被唤醒的节点（`WNode`）。
 * 将队列头部节点的状态从 `WAITING` 更新为 0（表示节点不再等待）。
 * 如果队列中的下一个节点（`q`）存在且状态不为 `CANCELLED`，唤醒线程。
 * 
 * @param h 队列中的头部节点。
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token class-name">WNode</span> h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">WNode</span> q<span class="token punctuation">;</span> <span class="token class-name">Thread</span> w<span class="token punctuation">;</span>
        <span class="token comment">// 更新队列头部节点的状态为 0</span>
        <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token constant">WSTATUS</span><span class="token punctuation">,</span> <span class="token constant">WAITING</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 查找下一个需要被唤醒的节点（如果下一个节点为空或者状态为 CANCELLED）</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>q <span class="token operator">=</span> h<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> q<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token constant">CANCELLED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">WNode</span> t <span class="token operator">=</span> wtail<span class="token punctuation">;</span> t <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> t <span class="token operator">!=</span> h<span class="token punctuation">;</span> t <span class="token operator">=</span> t<span class="token punctuation">.</span>prev<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>status <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    q <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 如果找到的节点存在且线程不为空，唤醒线程</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>q <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>w <span class="token operator">=</span> q<span class="token punctuation">.</span>thread<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>release方法总结：</strong><br> <strong>目标：</strong>  从队列中释放阻塞的线程，并确保下一个等待的线程被正确唤醒。</p> <p><strong>步骤：</strong><br> <strong>更新节点状态:</strong><br>
将队列头部节点的状态从 WAITING 更新为 0，表示该节点不再需要等待。此操作标志着头部节点已处理完毕，准备释放或处理下一个节点。</p> <p><strong>查找并设置下一个待唤醒的节点:</strong><br>
如果头部节点的下一个节点为空或状态为 CANCELLED，从队列尾部向前查找有效的待唤醒节点。这样可以确保唤醒操作的正确性，并避免唤醒已取消或不再需要的线程。</p> <p><strong>唤醒线程:</strong><br>
如果找到有效的待唤醒节点，并且该节点关联的线程不为空，则唤醒该线程。通过调用 U.unpark(w)，可以确保线程能够继续执行，减少系统中的线程阻塞时间。</p> <h3 id="stampedlock管理线程的队列"><a href="#stampedlock管理线程的队列" class="header-anchor">#</a> StampedLock管理线程的队列</h3> <p>StampedLock内部基于<code>WNode</code>实现的阻塞队列和AQS实现的阻塞队列类似。<br>
初始化时，新建个空节点，<code>whead=wtail=NULL</code> 。</p> <img src="/blog/images/39-2.png" alt="mixureSecure"> <p>之后再往里面加入一个个读线程或写线程节点。</p> <p>但是上面<code>acquireRead</code>和<code>acquireWrite</code>方法对于自旋的操作就和AQS有很大不同了。</p> <p>在<code>AQS</code>里面，当一个线程<code>CAS state</code>失败之后，会立即加入阻塞队列，并且进入阻塞状态。但在<code>StampedLock</code>中，<code>CAS state</code>失败之后，会不断自旋，自旋足够多的次数之后，如果还拿不到锁，才进入阻塞状态。为此，根据CPU的核数，定义了自旋次数的常量值。如果是单核的CPU，肯定不能自旋，在多核情况下，才采用自旋策略。</p> <p>还有个比较特殊的地方在于，每个WNode里面有一个cowait指针，用于串联起所有的读线程。<br>
例如，队列尾部阻塞的是一个读线程 1，现在又来了读线程 2、3，那么会通过cowait指针，把1、2、3串联起来。1被唤醒之后，2、3也随之一起被唤醒，因为读和读之间不互斥。</p> <p>也就是 当入队一个线程时，如果队尾是写结点，则直接链接到队尾。
当入队一个读线程时，如果队尾是读节点，则直接链接到该读结点的cowait链中。</p> <img src="/blog/images/39-3.png" alt="mixureSecure"> <h2 id="_4、stampedlock和reentrantreadwritelock对比"><a href="#_4、stampedlock和reentrantreadwritelock对比" class="header-anchor">#</a> 4、<code>StampedLock</code>和<code>ReentrantReadWriteLock</code>对比</h2> <table><thead><tr><th style="text-align:left;">特性</th> <th style="text-align:left;"><code>StampedLock</code></th> <th style="text-align:left;"><code>ReentrantReadWriteLock</code></th></tr></thead> <tbody><tr><td style="text-align:left;"><strong>引入版本</strong></td> <td style="text-align:left;">JDK 8</td> <td style="text-align:left;">JDK 5</td></tr> <tr><td style="text-align:left;"><strong>锁类型</strong></td> <td style="text-align:left;">提供乐观读锁、悲观读锁和写锁</td> <td style="text-align:left;">提供悲观读锁和写锁</td></tr> <tr><td style="text-align:left;"><strong>乐观读锁</strong></td> <td style="text-align:left;">支持（<code>tryOptimisticRead()</code>）</td> <td style="text-align:left;">不支持</td></tr> <tr><td style="text-align:left;"><strong>悲观读锁</strong></td> <td style="text-align:left;">支持（<code>readLock()</code>）</td> <td style="text-align:left;">支持（<code>readLock()</code>）</td></tr> <tr><td style="text-align:left;"><strong>写锁</strong></td> <td style="text-align:left;">支持（<code>writeLock()</code>）</td> <td style="text-align:left;">支持（<code>writeLock()</code>）</td></tr> <tr><td style="text-align:left;"><strong>锁升级</strong></td> <td style="text-align:left;">支持从乐观读锁升级到悲观读锁或写锁（<code>tryConvertToWriteLock()</code>等）</td> <td style="text-align:left;">不支持</td></tr> <tr><td style="text-align:left;"><strong>锁降级</strong></td> <td style="text-align:left;">支持从写锁降级为读锁（<code>tryConvertToReadLock()</code>）</td> <td style="text-align:left;">支持从写锁降级为读锁</td></tr> <tr><td style="text-align:left;"><strong>锁管理复杂度</strong></td> <td style="text-align:left;">复杂，需要管理戳记，确保在转换锁时一致性</td> <td style="text-align:left;">相对简单，直接使用 <code>readLock()</code> 和 <code>writeLock()</code></td></tr> <tr><td style="text-align:left;"><strong>性能优化</strong></td> <td style="text-align:left;">乐观读锁减少了锁竞争，提高了读取性能</td> <td style="text-align:left;">读写锁性能依赖于锁的竞争情况(大量并发读可能会导致写线程饥饿)</td></tr> <tr><td style="text-align:left;"><strong>公平性</strong></td> <td style="text-align:left;">不提供公平性（锁的获取是非公平的）</td> <td style="text-align:left;">可以选择公平性（通过构造函数 <code>ReentrantReadWriteLock(true)</code>）</td></tr> <tr><td style="text-align:left;"><strong>条件变量<code>Condition</code></strong></td> <td style="text-align:left;">不支持</td> <td style="text-align:left;">支持</td></tr></tbody></table> <h2 id="_5、-总结"><a href="#_5、-总结" class="header-anchor">#</a> 5、 总结</h2> <p><strong><code>StampedLock</code></strong> 适用于需要高效读取性能的场景，通过乐观读锁减少锁竞争，同时支持锁的升级和降级，但锁的管理相对复杂，不支持重入，并且使用乐观读锁时需要遵循一定的顺序，所以使用时一定要谨慎。</p> <p>参考资料：<br>
https://www.skjava.com/series/article/1446338301<br>
《Java并发编程之美》<br>
《Java并发实现原理:JDK源码剖析》</p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/blog/java-concurrent/十、ReentrantReadWriteLock详解.html" class="prev">
          十、ReentrantReadWriteLock详解
        </a></span> <span class="next"><a href="/blog/java-concurrent/十二、Java线程池.html">
          十二、Java线程池
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#_1、stampedlock简介" class="sidebar-link reco-side-_1、stampedlock简介" data-v-b57cc07c>1、StampedLock简介</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#stampedlock-三个主要的锁模式" class="sidebar-link reco-side-stampedlock-三个主要的锁模式" data-v-b57cc07c>StampedLock 三个主要的锁模式</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#戳记" class="sidebar-link reco-side-戳记" data-v-b57cc07c>戳记</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#获取锁和释放锁的方法" class="sidebar-link reco-side-获取锁和释放锁的方法" data-v-b57cc07c>获取锁和释放锁的方法</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#转换锁" class="sidebar-link reco-side-转换锁" data-v-b57cc07c>转换锁</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#并发度比较" class="sidebar-link reco-side-并发度比较" data-v-b57cc07c>并发度比较</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#_2、stampedlock简单使用示例" class="sidebar-link reco-side-_2、stampedlock简单使用示例" data-v-b57cc07c>2、StampedLock简单使用示例</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#使用乐观读锁需要遵循一定的规则" class="sidebar-link reco-side-使用乐观读锁需要遵循一定的规则" data-v-b57cc07c>使用乐观读锁需要遵循一定的规则：</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#validate方法的注意点" class="sidebar-link reco-side-validate方法的注意点" data-v-b57cc07c>validate方法的注意点</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#_3、stampedlock获取释放锁详解" class="sidebar-link reco-side-_3、stampedlock获取释放锁详解" data-v-b57cc07c>3、StampedLock获取释放锁详解</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#类继承结构" class="sidebar-link reco-side-类继承结构" data-v-b57cc07c>类继承结构</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#类属性" class="sidebar-link reco-side-类属性" data-v-b57cc07c>类属性</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#stampedlock对于state变量的设计" class="sidebar-link reco-side-stampedlock对于state变量的设计" data-v-b57cc07c>StampedLock对于state变量的设计</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#stampedlock乐观锁实现原理" class="sidebar-link reco-side-stampedlock乐观锁实现原理" data-v-b57cc07c>StampedLock乐观锁实现原理</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#stampedlock的构造方法" class="sidebar-link reco-side-stampedlock的构造方法" data-v-b57cc07c>StampedLock的构造方法</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#tryoptimisticread方法" class="sidebar-link reco-side-tryoptimisticread方法" data-v-b57cc07c>tryOptimisticRead方法</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#readlock-方法" class="sidebar-link reco-side-readlock-方法" data-v-b57cc07c>readLock 方法</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#unlockread方法" class="sidebar-link reco-side-unlockread方法" data-v-b57cc07c>unlockRead方法</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#writelock-方法" class="sidebar-link reco-side-writelock-方法" data-v-b57cc07c>writeLock 方法</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#unlockwrite方法" class="sidebar-link reco-side-unlockwrite方法" data-v-b57cc07c>unlockWrite方法</a></li><li class="level-3" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#stampedlock管理线程的队列" class="sidebar-link reco-side-stampedlock管理线程的队列" data-v-b57cc07c>StampedLock管理线程的队列</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#_4、stampedlock和reentrantreadwritelock对比" class="sidebar-link reco-side-_4、stampedlock和reentrantreadwritelock对比" data-v-b57cc07c>4、StampedLock和ReentrantReadWriteLock对比</a></li><li class="level-2" data-v-b57cc07c><a href="/blog/java-concurrent/%E5%8D%81%E4%B8%80%E3%80%81StampedLock%E8%AF%A6%E8%A7%A3.html#_5、-总结" class="sidebar-link reco-side-_5、-总结" data-v-b57cc07c>5、 总结</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/blog/assets/js/app.aa36b75b.js" defer></script><script src="/blog/assets/js/7.272de20f.js" defer></script><script src="/blog/assets/js/2.cc89bbf4.js" defer></script><script src="/blog/assets/js/1.fb256d2a.js" defer></script><script src="/blog/assets/js/62.67670094.js" defer></script>
  </body>
</html>
